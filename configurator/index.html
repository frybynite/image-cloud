<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery Configurator</title>
    <link rel="stylesheet" href="../dist/style.css">
    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e5e5e5;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 2000;
        }

        .header h1 {
            margin: 0;
            font-size: 18px;
            color: #fff;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .path-toggle {
            background: none;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            color: #888;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .path-toggle:hover {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        .path-toggle.active {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        .help-btn {
            background: none;
            border: 1px solid #444;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            color: #888;
            font-size: 14px;
            transition: all 0.2s;
        }

        .help-btn:hover {
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        /* Sidebar */
        .sidebar {
            width: 400px;
            min-width: 400px;
            height: calc(100% - 50px);
            margin-top: 50px;
            background: rgba(0, 0, 0, 0.95);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid #333;
            background: rgba(0, 0, 0, 0.5);
        }

        /* Preset Section */
        .preset-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .preset-section label {
            display: block;
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .preset-select {
            width: 100%;
            padding: 10px 12px;
            background: #222;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .image-count-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .image-count-control input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 3px;
            cursor: pointer;
        }

        .image-count-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #8b5cf6;
            border-radius: 50%;
            cursor: pointer;
        }

        .image-count-value {
            min-width: 32px;
            padding: 6px 10px;
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            color: #8b5cf6;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }

        .preset-select:hover {
            border-color: #8b5cf6;
        }

        .preset-select:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        /* Accordion */
        .accordion {
            margin-bottom: 10px;
        }

        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .accordion-header:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .accordion.open .accordion-header {
            border-radius: 8px 8px 0 0;
            border-bottom-color: transparent;
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .accordion-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            transition: all 0.2s;
        }

        .accordion-title.show-path {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 12px;
            color: #8b5cf6;
        }

        .accordion-arrow {
            color: #888;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .accordion.open .accordion-arrow {
            transform: rotate(180deg);
        }

        .accordion-content {
            display: none;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
            border-radius: 0 0 8px 8px;
        }

        .accordion.open .accordion-content {
            display: block;
            border-color: rgba(139, 92, 246, 0.3);
        }

        /* Control Groups */
        .control-group {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .control-group-title {
            font-size: 11px;
            letter-spacing: 0.5px;
            color: #8b5cf6;
            margin: 0 0 10px 0;
            transition: all 0.2s;
        }

        .control-group-title.show-path {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            text-transform: none;
            letter-spacing: 0;
            font-size: 10px;
        }

        /* Control Row */
        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-checkbox {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
            accent-color: #8b5cf6;
            cursor: pointer;
        }

        .control-label {
            flex: 0 0 110px;
            font-size: 12px;
            color: #aaa;
            transition: all 0.2s;
        }

        .control-label.show-path {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 10px;
            color: #8b5cf6;
        }

        .control-input {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-row.disabled .control-label {
            color: #555;
        }

        .control-row.disabled .control-input {
            opacity: 0.4;
            pointer-events: none;
        }

        /* Custom Shadow Controls */
        .custom-shadow-controls {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            margin-left: 24px;
            margin-bottom: 12px;
        }

        .custom-shadow-controls .control-row {
            margin-bottom: 8px;
        }

        .custom-shadow-controls .control-row:last-child {
            margin-bottom: 0;
        }

        .custom-shadow-controls .control-label {
            flex: 0 0 70px;
        }

        .custom-shadow-format-hint {
            display: none;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 10px;
            color: #8b5cf6;
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .custom-shadow-format-hint.show-path {
            display: block;
        }

        /* Input Styles */
        input[type="number"] {
            width: 70px;
            padding: 6px 8px;
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 3px;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #8b5cf6;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="color"] {
            width: 40px;
            height: 28px;
            padding: 0;
            border: 1px solid #444;
            border-radius: 6px;
            background: #222;
            cursor: pointer;
        }

        select {
            padding: 6px 10px;
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .value-display {
            min-width: 32px;
            text-align: right;
            font-size: 12px;
            color: #8b5cf6;
            font-family: 'SF Mono', Monaco, monospace;
            flex-shrink: 0;
        }

        .control-hint {
            font-size: 10px;
            color: #666;
            font-style: italic;
            margin-top: 4px;
            padding-left: 24px;
        }

        /* Buttons */
        .show-config-btn {
            width: 100%;
            padding: 10px;
            background: transparent;
            color: #8b5cf6;
            border: 1px solid #8b5cf6;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .show-config-btn:hover {
            background: rgba(139, 92, 246, 0.1);
        }

        /* Gallery Preview */
        .gallery-preview {
            flex: 1;
            height: calc(100% - 50px);
            margin-top: 50px;
            position: relative;
            overflow: hidden;
        }

        .gallery-container {
            width: 100%;
            height: 100%;
        }

        #imageCloud {
            width: 100%;
            height: 100%;
        }

        /* Config Modal */
        .config-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .config-modal.active {
            display: flex;
        }

        .config-content {
            background: #1a1a2e;
            border: 1px solid #444;
            border-radius: 12px;
            padding: 20px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow: auto;
            position: relative;
        }

        .config-content h4 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 16px;
        }

        .config-content pre {
            background: #0d0d1a;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            color: #e5e5e5;
            margin: 0;
            line-height: 1.5;
        }

        .config-content .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }

        .config-content .close-btn:hover {
            color: #fff;
        }

        .config-content .copy-btn {
            padding: 10px 20px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .config-content .copy-btn:hover {
            background: #7c3aed;
        }

        .config-content .copy-btn.copied {
            background: #22c55e;
        }

        .config-options {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .config-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #aaa;
            font-size: 13px;
            cursor: pointer;
        }

        .config-options input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #8b5cf6;
            cursor: pointer;
        }

        /* Help Modal */
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .help-modal.active {
            display: flex;
        }

        .help-content {
            background: #1a1a2e;
            border: 1px solid #444;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }

        .help-content h4 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 18px;
        }

        .help-content p {
            color: #aaa;
            line-height: 1.6;
            margin: 0 0 12px 0;
            font-size: 14px;
        }

        .help-content ul {
            color: #aaa;
            line-height: 1.8;
            margin: 0;
            padding-left: 20px;
            font-size: 14px;
        }

        .help-content .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }

        .help-content .close-btn:hover {
            color: #fff;
        }

        /* Mobile Styles */
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 8px;
            left: 10px;
            z-index: 2001;
            background: rgba(139, 92, 246, 0.9);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .header h1 {
                margin-left: 50px;
                font-size: 16px;
            }

            .mobile-toggle {
                display: block;
            }

            .sidebar {
                position: fixed;
                left: -360px;
                top: 0;
                height: 100%;
                margin-top: 0;
                padding-top: 50px;
                transition: left 0.3s ease;
                z-index: 1500;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1400;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .gallery-preview {
                width: 100%;
            }
        }

        /* Algorithm-specific controls visibility */
        .algorithm-specific {
            display: none;
        }

        .algorithm-specific.visible {
            display: block;
        }

        /* Subsection toggle */
        .subsection-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .subsection-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #8b5cf6;
            cursor: pointer;
        }

        .subsection-toggle label {
            font-size: 12px;
            color: #fff;
            cursor: pointer;
        }

        .subsection-content {
            padding-left: 24px;
        }

        .subsection-content.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* Allow tooltips on labels even when parent is disabled */
        .subsection-content.disabled [data-path] {
            pointer-events: auto;
        }

        /* Tooltip for label descriptions */
        .tooltip {
            position: absolute;
            left: 0;
            top: 100%;
            margin-top: 4px;
            padding: 6px 10px;
            background: #3a3a3a;
            color: #ccc;
            font-size: 11px;
            font-style: normal;
            font-weight: normal;
            border-radius: 4px;
            white-space: normal;
            width: max-content;
            max-width: 250px;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* State Selector (Segmented Control) */
        .state-selector {
            display: flex;
            background: #222;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 3px;
            margin-bottom: 8px;
        }

        /* Styling path prefix */
        .styling-path-prefix {
            display: none;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 10px;
            color: #8b5cf6;
            margin: 0 0 10px 0;
        }

        .styling-path-prefix.show-path {
            display: block;
        }

        .state-selector-btn {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #888;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .state-selector-btn:hover {
            color: #ccc;
        }

        .state-selector-btn.active {
            background: #8b5cf6;
            color: #fff;
        }

        /* Inheritance indicator for styling controls */
        .control-row.inherited .control-label {
            color: #666;
        }

        .control-row.inherited .control-input {
            opacity: 0.5;
        }

        .control-row.inherited .value-display {
            color: #666;
        }

        /* Clear overrides button */
        .clear-overrides-btn {
            width: 100%;
            padding: 8px 12px;
            margin-top: 15px;
            background: transparent;
            border: 1px solid #555;
            border-radius: 6px;
            color: #888;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-overrides-btn:hover {
            border-color: #f87171;
            color: #f87171;
        }

        .clear-overrides-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .clear-overrides-btn:disabled:hover {
            border-color: #555;
            color: #888;
        }

        /* Border Section Box */
        .border-section-box {
            border: 1px solid #444;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        /* Section Separator */
        .section-separator {
            height: 1px;
            background: #333;
            margin: 12px 0;
        }

        /* Side Selector (smaller than state selector) */
        .side-selector {
            display: flex;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 2px;
            margin-bottom: 12px;
        }

        .side-selector-btn {
            flex: 1;
            padding: 5px 6px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: #888;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .side-selector-btn:hover {
            color: #ccc;
        }

        .side-selector-btn.active {
            background: #8b5cf6;
            color: #fff;
        }
    </style>
</head>
<body>
    <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞ Config</button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <header class="header">
        <h1>Gallery Configurator</h1>
        <div class="header-actions">
            <button class="path-toggle" onclick="togglePaths()" title="Toggle JSON paths">
                <span>üëÅ</span>
                <span>Paths</span>
            </button>
            <button class="help-btn" onclick="showHelp()" title="Help">?</button>
        </div>
    </header>

    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-content">
                <!-- Presets -->
                <div class="preset-section">
                    <label>Preset</label>
                    <select class="preset-select" id="presetSelect" onchange="applyPreset(this.value)">
                        <option value="default">Default</option>
                        <option value="scattered-photos">Scattered Photos</option>
                        <option value="clean-grid">Clean Grid</option>
                        <option value="polaroid">Polaroid</option>
                        <option value="vintage">Vintage</option>
                        <option value="neon-glow">Neon Glow</option>
                        <option value="minimal">Minimal</option>
                        <option value="dramatic">Dramatic</option>
                    </select>
                </div>

                <div class="preset-section">
                    <label>Image Count</label>
                    <div class="image-count-control">
                        <input type="range" id="imageCount" min="5" max="100" step="1" value="20" oninput="updateImageCount(this)">
                        <span class="image-count-value" id="imageCountValue">20</span>
                    </div>
                </div>

                <!-- Layout Section -->
                <div class="accordion open" data-section="layout">
                    <div class="accordion-header" onclick="toggleAccordion(this.parentElement)">
                        <span class="accordion-title" data-label="Layout" data-path="layout" data-desc-key="layout">Layout</span>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <!-- Algorithm -->
                        <div class="control-group">
                            <h5 class="control-group-title" data-label="Algorithm" data-path="layout" data-desc-key="layout.algorithm">Algorithm</h5>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-algorithm" checked>
                                <label class="control-label" data-label="Type" data-path="algorithm" data-desc-key="layout.algorithm.type">Type</label>
                                <div class="control-input">
                                    <select id="layout-algorithm" onchange="onAlgorithmChange()">
                                        <option value="radial">Radial</option>
                                        <option value="grid">Grid</option>
                                        <option value="spiral">Spiral</option>
                                        <option value="cluster">Cluster</option>
                                        <option value="wave">Wave</option>
                                        <option value="random">Random</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Grid-specific options -->
                            <div class="algorithm-specific" data-algorithm="grid">
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-grid-columns">
                                    <label class="control-label" data-label="Columns" data-path="grid.columns" data-desc-key="layout.grid.columns">Columns</label>
                                    <div class="control-input">
                                        <input type="number" id="grid-columns" value="4" min="1" max="12">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-grid-rows">
                                    <label class="control-label" data-label="Rows" data-path="grid.rows" data-desc-key="layout.grid.rows">Rows</label>
                                    <div class="control-input">
                                        <input type="number" id="grid-rows" value="3" min="1" max="12">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-grid-gap">
                                    <label class="control-label" data-label="Gap" data-path="grid.gap" data-desc-key="layout.grid.gap">Gap</label>
                                    <div class="control-input">
                                        <input type="number" id="grid-gap" value="10" min="0" max="100">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-grid-stagger">
                                    <label class="control-label" data-label="Stagger" data-path="grid.stagger" data-desc-key="layout.grid.stagger">Stagger</label>
                                    <div class="control-input">
                                        <select id="grid-stagger">
                                            <option value="none">None</option>
                                            <option value="row">Row</option>
                                            <option value="column">Column</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-grid-jitter">
                                    <label class="control-label" data-label="Jitter" data-path="grid.jitter" data-desc-key="layout.grid.jitter">Jitter</label>
                                    <div class="control-input">
                                        <span class="value-display">0</span>
                                        <input type="range" id="grid-jitter" min="0" max="50" step="5" value="0" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-grid-overlap">
                                    <label class="control-label" data-label="Overlap" data-path="grid.overlap" data-desc-key="layout.grid.overlap">Overlap</label>
                                    <div class="control-input">
                                        <span class="value-display">0</span>
                                        <input type="range" id="grid-overlap" min="0" max="0.5" step="0.05" value="0" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-grid-fillDirection">
                                    <label class="control-label" data-label="Fill Direction" data-path="grid.fillDirection" data-desc-key="layout.grid.fillDirection">Fill Direction</label>
                                    <div class="control-input">
                                        <select id="grid-fillDirection">
                                            <option value="row">Row</option>
                                            <option value="column">Column</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-grid-alignment">
                                    <label class="control-label" data-label="Alignment" data-path="grid.alignment" data-desc-key="layout.grid.alignment">Alignment</label>
                                    <div class="control-input">
                                        <select id="grid-alignment">
                                            <option value="start">Start</option>
                                            <option value="center">Center</option>
                                            <option value="end">End</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-grid-overflowOffset">
                                    <label class="control-label" data-label="Overflow Offset" data-path="grid.overflowOffset" data-desc-key="layout.grid.overflowOffset">Overflow Offset</label>
                                    <div class="control-input">
                                        <span class="value-display">0.25</span>
                                        <input type="range" id="grid-overflowOffset" min="0" max="0.5" step="0.05" value="0.25" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                            </div>

                            <!-- Spiral-specific options -->
                            <div class="algorithm-specific" data-algorithm="spiral">
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-spiral-type">
                                    <label class="control-label" data-label="Spiral Type" data-path="spiral.spiralType" data-desc-key="layout.spiral.spiralType">Spiral Type</label>
                                    <div class="control-input">
                                        <select id="spiral-type">
                                            <option value="golden">Golden</option>
                                            <option value="archimedean">Archimedean</option>
                                            <option value="logarithmic">Logarithmic</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-spiral-direction">
                                    <label class="control-label" data-label="Direction" data-path="spiral.direction" data-desc-key="layout.spiral.direction">Direction</label>
                                    <div class="control-input">
                                        <select id="spiral-direction">
                                            <option value="clockwise">Clockwise</option>
                                            <option value="counterclockwise">Counter-clockwise</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-spiral-tightness">
                                    <label class="control-label" data-label="Tightness" data-path="spiral.tightness" data-desc-key="layout.spiral.tightness">Tightness</label>
                                    <div class="control-input">
                                        <span class="value-display">1.0</span>
                                        <input type="range" id="spiral-tightness" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-spiral-startAngle">
                                    <label class="control-label" data-label="Start Angle" data-path="spiral.startAngle" data-desc-key="layout.spiral.startAngle">Start Angle</label>
                                    <div class="control-input">
                                        <span class="value-display">0¬∞</span>
                                        <input type="range" id="spiral-startAngle" min="0" max="360" step="15" value="0" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                            </div>

                            <!-- Cluster-specific options -->
                            <div class="algorithm-specific" data-algorithm="cluster">
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-cluster-count">
                                    <label class="control-label" data-label="Cluster Count" data-path="cluster.clusterCount" data-desc-key="layout.cluster.clusterCount">Cluster Count</label>
                                    <div class="control-input">
                                        <input type="number" id="cluster-count" value="3" min="1" max="10">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-cluster-spread">
                                    <label class="control-label" data-label="Cluster Spread" data-path="cluster.clusterSpread" data-desc-key="layout.cluster.clusterSpread">Cluster Spread</label>
                                    <div class="control-input">
                                        <span class="value-display">150</span>
                                        <input type="range" id="cluster-spread" min="50" max="300" step="10" value="150" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-cluster-spacing">
                                    <label class="control-label" data-label="Cluster Spacing" data-path="cluster.clusterSpacing" data-desc-key="layout.cluster.clusterSpacing">Cluster Spacing</label>
                                    <div class="control-input">
                                        <span class="value-display">200</span>
                                        <input type="range" id="cluster-spacing" min="50" max="400" step="10" value="200" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-cluster-overlap">
                                    <label class="control-label" data-label="Overlap" data-path="cluster.overlap" data-desc-key="layout.cluster.overlap">Overlap</label>
                                    <div class="control-input">
                                        <span class="value-display">0.2</span>
                                        <input type="range" id="cluster-overlap" min="0" max="0.5" step="0.05" value="0.2" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-cluster-density">
                                    <label class="control-label" data-label="Density" data-path="cluster.density" data-desc-key="layout.cluster.density">Density</label>
                                    <div class="control-input">
                                        <select id="cluster-density">
                                            <option value="uniform">Uniform</option>
                                            <option value="varied">Varied</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-cluster-distribution">
                                    <label class="control-label" data-label="Distribution" data-path="cluster.distribution" data-desc-key="layout.cluster.distribution">Distribution</label>
                                    <div class="control-input">
                                        <select id="cluster-distribution">
                                            <option value="gaussian">Gaussian</option>
                                            <option value="uniform">Uniform</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Wave-specific options -->
                            <div class="algorithm-specific" data-algorithm="wave">
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-wave-rows">
                                    <label class="control-label" data-label="Rows" data-path="wave.rows" data-desc-key="layout.wave.rows">Rows</label>
                                    <div class="control-input">
                                        <input type="number" id="wave-rows" value="3" min="1" max="10">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-wave-amplitude">
                                    <label class="control-label" data-label="Amplitude" data-path="wave.amplitude" data-desc-key="layout.wave.amplitude">Amplitude</label>
                                    <div class="control-input">
                                        <span class="value-display">100</span>
                                        <input type="range" id="wave-amplitude" min="20" max="200" step="10" value="100" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-wave-frequency">
                                    <label class="control-label" data-label="Frequency" data-path="wave.frequency" data-desc-key="layout.wave.frequency">Frequency</label>
                                    <div class="control-input">
                                        <span class="value-display">2</span>
                                        <input type="range" id="wave-frequency" min="0.5" max="5" step="0.5" value="2" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-wave-phaseShift">
                                    <label class="control-label" data-label="Phase Shift" data-path="wave.phaseShift" data-desc-key="layout.wave.phaseShift">Phase Shift</label>
                                    <div class="control-input">
                                        <span class="value-display">1.0</span>
                                        <input type="range" id="wave-phaseShift" min="0" max="6.28" step="0.1" value="1.047" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-wave-synchronization">
                                    <label class="control-label" data-label="Synchronization" data-path="wave.synchronization" data-desc-key="layout.wave.synchronization">Synchronization</label>
                                    <div class="control-input">
                                        <select id="wave-synchronization">
                                            <option value="offset">Offset</option>
                                            <option value="synchronized">Synchronized</option>
                                            <option value="alternating">Alternating</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Note: Wave orientation is now controlled via Image > Rotation > Mode = Tangent -->
                            </div>
                        </div>

                        <!-- Layout Controls -->
                        <div class="control-group">
                            <h5 class="control-group-title" data-label="Layout Controls" data-path="layout" data-desc-key="layout">Layout Controls</h5>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-layout-coverage">
                                <label class="control-label" data-label="Target Coverage" data-path="targetCoverage" data-desc-key="layout.targetCoverage">Target Coverage</label>
                                <div class="control-input">
                                    <span class="value-display">0.6</span>
                                    <input type="range" id="layout-coverage" min="0.3" max="0.9" step="0.05" value="0.6" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-layout-density">
                                <label class="control-label" data-label="Density Factor" data-path="densityFactor" data-desc-key="layout.densityFactor">Density Factor</label>
                                <div class="control-input">
                                    <span class="value-display">1.0</span>
                                    <input type="range" id="layout-density" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>
                            <!-- Scale Decay - only for radial/spiral -->
                            <div class="algorithm-specific" data-algorithms="radial,spiral">
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-layout-scaleDecay">
                                    <label class="control-label" data-label="Scale Decay" data-path="scaleDecay" data-desc-key="layout.scaleDecay">Scale Decay</label>
                                    <div class="control-input">
                                        <span class="value-display">0</span>
                                        <input type="range" id="layout-scaleDecay" min="0" max="1" step="0.05" value="0" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Spacing -->
                        <div class="control-group">
                            <h5 class="control-group-title" data-label="Spacing" data-path="layout.spacing" data-desc-key="layout.spacing">Spacing</h5>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-spacing-padding">
                                <label class="control-label" data-label="Padding" data-path="padding" data-desc-key="layout.spacing.padding">Padding</label>
                                <div class="control-input">
                                    <input type="number" id="spacing-padding" value="50" min="0" max="200">
                                    <span class="value-display">px</span>
                                </div>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-spacing-minGap">
                                <label class="control-label" data-label="Min Gap" data-path="minGap" data-desc-key="layout.spacing.minGap">Min Gap</label>
                                <div class="control-input">
                                    <input type="number" id="spacing-minGap" value="20" min="0" max="100">
                                    <span class="value-display">px</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Image: Size & Rotation Section -->
                <div class="accordion" data-section="image">
                    <div class="accordion-header" onclick="toggleAccordion(this.parentElement)">
                        <span class="accordion-title" data-label="Image: Size & Rotation" data-path="image" data-desc-key="image">Image: Size & Rotation</span>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <!-- Image Sizing -->
                        <div class="control-group">
                            <h5 class="control-group-title" data-label="Sizing" data-path="image.sizing" data-desc-key="image.sizing">Sizing</h5>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-image-sizing-mode" checked>
                                <label class="control-label" data-label="Mode" data-path="mode" data-desc-key="image.sizing.mode">Mode</label>
                                <div class="control-input">
                                    <select id="image-sizing-mode" onchange="toggleSizingMode()">
                                        <option value="adaptive" selected>Adaptive (default)</option>
                                        <option value="fixed">Fixed</option>
                                        <option value="responsive">Responsive</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Fixed mode controls -->
                            <div id="fixed-sizing-controls" style="display: none;">
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-image-height" checked>
                                    <label class="control-label" data-label="Height" data-path="height" data-desc-key="image.sizing.height">Height</label>
                                    <div class="control-input">
                                        <input type="number" id="image-height" value="150" min="50" max="500">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Responsive mode controls -->
                            <div id="responsive-sizing-controls" style="display: none;">
                                <div class="control-row">
                                    <span class="control-checkbox" style="width: 16px;"></span>
                                    <label class="control-label" data-label="Height" data-path="height" data-desc-key="image.sizing.height">Height</label>
                                </div>
                                <div class="control-row">
                                    <span style="width: 16px;"></span>
                                    <input type="checkbox" class="control-checkbox" id="enable-height-mobile" checked>
                                    <label class="control-label" data-label="Mobile" data-path="height.mobile" data-desc-key="image.sizing.height.mobile">Mobile</label>
                                    <div class="control-input">
                                        <input type="number" id="height-mobile" value="100" min="50" max="500">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <span style="width: 16px;"></span>
                                    <input type="checkbox" class="control-checkbox" id="enable-height-tablet" checked>
                                    <label class="control-label" data-label="Tablet" data-path="height.tablet" data-desc-key="image.sizing.height.tablet">Tablet</label>
                                    <div class="control-input">
                                        <input type="number" id="height-tablet" value="150" min="50" max="500">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <span style="width: 16px;"></span>
                                    <input type="checkbox" class="control-checkbox" id="enable-height-screen" checked>
                                    <label class="control-label" data-label="Screen" data-path="height.screen" data-desc-key="image.sizing.height.screen">Screen</label>
                                    <div class="control-input">
                                        <input type="number" id="height-screen" value="200" min="50" max="500">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Adaptive mode controls -->
                            <div id="adaptive-sizing-controls">
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-image-minSize">
                                    <label class="control-label" data-label="Min Size" data-path="minSize" data-desc-key="image.sizing.minSize">Min Size</label>
                                    <div class="control-input">
                                        <input type="number" id="image-minSize" value="50" min="20" max="200">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-image-maxSize">
                                    <label class="control-label" data-label="Max Size" data-path="maxSize" data-desc-key="image.sizing.maxSize">Max Size</label>
                                    <div class="control-input">
                                        <input type="number" id="image-maxSize" value="400" min="100" max="800">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-image-variance-min">
                                <label class="control-label" data-label="Variance Min" data-path="variance.min" data-desc-key="image.sizing.variance.min">Variance Min</label>
                                <div class="control-input">
                                    <span class="value-display">1.0</span>
                                    <input type="range" id="image-variance-min" min="0.25" max="1.0" step="0.05" value="1.0" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-image-variance-max">
                                <label class="control-label" data-label="Variance Max" data-path="variance.max" data-desc-key="image.sizing.variance.max">Variance Max</label>
                                <div class="control-input">
                                    <span class="value-display">1.0</span>
                                    <input type="range" id="image-variance-max" min="1.0" max="1.75" step="0.05" value="1.0" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>
                        </div>

                        <!-- Image Rotation -->
                        <div class="control-group">
                            <h5 class="control-group-title" data-label="Rotation" data-path="image.rotation" data-desc-key="image.rotation">Rotation</h5>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-image-rotation-mode">
                                <label class="control-label" data-label="Mode" data-path="mode" data-desc-key="image.rotation.mode">Mode</label>
                                <div class="control-input">
                                    <select id="image-rotation-mode" onchange="toggleRotationRange()">
                                        <option value="none">None (default)</option>
                                        <option value="random">Random</option>
                                        <option value="tangent">Tangent (Wave/Spiral)</option>
                                    </select>
                                </div>
                            </div>
                            <div id="rotation-range-controls" style="display: none;">
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-image-rotation-min">
                                    <label class="control-label" data-label="Min Degrees" data-path="range.min" data-desc-key="image.rotation.range.min">Min Degrees</label>
                                    <div class="control-input">
                                        <span class="value-display">-15¬∞</span>
                                        <input type="range" id="image-rotation-min" min="-45" max="0" step="1" value="-15" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-image-rotation-max">
                                    <label class="control-label" data-label="Max Degrees" data-path="range.max" data-desc-key="image.rotation.range.max">Max Degrees</label>
                                    <div class="control-input">
                                        <span class="value-display">15¬∞</span>
                                        <input type="range" id="image-rotation-max" min="0" max="45" step="1" value="15" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image: Style Section -->
                <div class="accordion" data-section="styling">
                    <div class="accordion-header" onclick="toggleAccordion(this.parentElement)">
                        <span class="accordion-title" data-label="Image: Style" data-path="styling" data-desc-key="styling">Image: Style</span>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <!-- State Selector -->
                        <div class="state-selector" id="styling-state-selector">
                            <button type="button" class="state-selector-btn active" data-state="default" onclick="selectStylingState('default')">Default</button>
                            <button type="button" class="state-selector-btn" data-state="hover" onclick="selectStylingState('hover')">Hover</button>
                            <button type="button" class="state-selector-btn" data-state="focused" onclick="selectStylingState('focused')">Focused</button>
                        </div>

                        <!-- Path Prefix (shown when paths mode is active) -->
                        <div class="styling-path-prefix" id="styling-path-prefix">styling.default</div>

                        <!-- Unified Style Controls -->
                        <div class="control-group" id="styling-controls">
                            <!-- Border Section Box -->
                            <div class="border-section-box">
                                <!-- Side Selector -->
                                <div class="side-selector" id="border-side-selector">
                                    <button type="button" class="side-selector-btn active" data-side="all" onclick="selectBorderSide('all')">All</button>
                                    <button type="button" class="side-selector-btn" data-side="top" onclick="selectBorderSide('top')">Top</button>
                                    <button type="button" class="side-selector-btn" data-side="right" onclick="selectBorderSide('right')">Right</button>
                                    <button type="button" class="side-selector-btn" data-side="bottom" onclick="selectBorderSide('bottom')">Bottom</button>
                                    <button type="button" class="side-selector-btn" data-side="left" onclick="selectBorderSide('left')">Left</button>
                                </div>

                                <!-- Border Controls -->
                                <div class="control-row" data-property="border.width">
                                    <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-border-width">
                                    <label class="control-label" data-label="Border Width" data-path="border.width" data-desc-key="styling.border.width">Border Width</label>
                                    <div class="control-input">
                                        <input type="number" id="style-border-width" value="0" min="0" max="20">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                                <div class="control-row" data-property="border.color">
                                    <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-border-color">
                                    <label class="control-label" data-label="Border Color" data-path="border.color" data-desc-key="styling.border.color">Border Color</label>
                                    <div class="control-input">
                                        <input type="color" id="style-border-color" value="#000000">
                                    </div>
                                </div>
                                <div class="control-row" data-property="border.style">
                                    <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-border-style">
                                    <label class="control-label" data-label="Border Style" data-path="border.style" data-desc-key="styling.border.style">Border Style</label>
                                    <div class="control-input">
                                        <select id="style-border-style">
                                            <option value="solid" selected>Solid</option>
                                            <option value="dashed">Dashed</option>
                                            <option value="dotted">Dotted</option>
                                            <option value="double">Double</option>
                                            <option value="none">None</option>
                                            <option value="groove">Groove</option>
                                            <option value="ridge">Ridge</option>
                                            <option value="inset">Inset</option>
                                            <option value="outset">Outset</option>
                                            <option value="hidden">Hidden</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Outline Controls (only shown when "All" side is selected) -->
                                <div id="outline-controls-wrapper">
                                    <div class="section-separator"></div>
                                    <div class="control-row" data-property="outline.width">
                                        <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-outline-width">
                                        <label class="control-label" data-label="Outline Width" data-path="outline.width" data-desc-key="styling.outline.width">Outline Width</label>
                                        <div class="control-input">
                                            <input type="number" id="style-outline-width" value="0" min="0" max="20">
                                            <span class="value-display">px</span>
                                        </div>
                                    </div>
                                    <div class="control-row" data-property="outline.color">
                                        <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-outline-color">
                                        <label class="control-label" data-label="Outline Color" data-path="outline.color" data-desc-key="styling.outline.color">Outline Color</label>
                                        <div class="control-input">
                                            <input type="color" id="style-outline-color" value="#000000">
                                        </div>
                                    </div>
                                    <div class="control-row" data-property="outline.style">
                                        <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-outline-style">
                                        <label class="control-label" data-label="Outline Style" data-path="outline.style" data-desc-key="styling.outline.style">Outline Style</label>
                                        <div class="control-input">
                                            <select id="style-outline-style">
                                                <option value="solid" selected>Solid</option>
                                                <option value="dashed">Dashed</option>
                                                <option value="dotted">Dotted</option>
                                                <option value="double">Double</option>
                                                <option value="none">None</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="control-row" data-property="outline.offset">
                                        <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-outline-offset">
                                        <label class="control-label" data-label="Outline Offset" data-path="outline.offset" data-desc-key="styling.outline.offset">Outline Offset</label>
                                        <div class="control-input">
                                            <input type="number" id="style-outline-offset" value="0" min="-10" max="20">
                                            <span class="value-display">px</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Border Radius Section Box -->
                            <div class="border-section-box">
                                <!-- Corner Selector -->
                                <div class="side-selector" id="border-radius-corner-selector">
                                    <button type="button" class="side-selector-btn active" data-corner="all" onclick="selectBorderRadiusCorner('all')">All</button>
                                    <button type="button" class="side-selector-btn" data-corner="ul" onclick="selectBorderRadiusCorner('ul')">UL</button>
                                    <button type="button" class="side-selector-btn" data-corner="ur" onclick="selectBorderRadiusCorner('ur')">UR</button>
                                    <button type="button" class="side-selector-btn" data-corner="br" onclick="selectBorderRadiusCorner('br')">BR</button>
                                    <button type="button" class="side-selector-btn" data-corner="bl" onclick="selectBorderRadiusCorner('bl')">BL</button>
                                </div>

                                <!-- Border Radius Control -->
                                <div class="control-row" data-property="border.radius">
                                    <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-border-radius">
                                    <label class="control-label" data-label="Border Radius" data-path="border.radius" data-desc-key="styling.border.radius">Border Radius</label>
                                    <div class="control-input">
                                        <input type="number" id="style-border-radius" value="0" min="0" max="50">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Shadow -->
                            <div class="control-row" data-property="shadow">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-shadow">
                                <label class="control-label" data-label="Shadow" data-path="shadow" data-desc-key="styling.shadow">Shadow</label>
                                <div class="control-input">
                                    <select id="style-shadow">
                                        <option value="none" selected>None</option>
                                        <option value="sm">Small</option>
                                        <option value="md">Medium</option>
                                        <option value="lg">Large</option>
                                        <option value="glow">Glow</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Custom Shadow Controls -->
                            <div class="custom-shadow-controls" id="custom-shadow-controls" style="display: none;">
                                <div class="custom-shadow-format-hint" id="custom-shadow-format-hint">x-offset y-offset blur rgba(color, opacity)</div>
                                <div class="control-row">
                                    <label class="control-label" data-path="shadowCustom.offsetX" data-desc-key="styling.shadowCustom.offsetX">X Offset</label>
                                    <div class="control-input">
                                        <input type="number" id="shadow-offset-x" value="0">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <label class="control-label" data-path="shadowCustom.offsetY" data-desc-key="styling.shadowCustom.offsetY">Y Offset</label>
                                    <div class="control-input">
                                        <input type="number" id="shadow-offset-y" value="4">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <label class="control-label" data-path="shadowCustom.blur" data-desc-key="styling.shadowCustom.blur">Blur</label>
                                    <div class="control-input">
                                        <input type="number" id="shadow-blur" value="16" min="0">
                                        <span class="value-display">px</span>
                                    </div>
                                </div>
                                <div class="control-row">
                                    <label class="control-label" data-path="shadowCustom.color" data-desc-key="styling.shadowCustom.color">Color</label>
                                    <div class="control-input">
                                        <input type="color" id="shadow-color" value="#000000">
                                    </div>
                                </div>
                                <div class="control-row">
                                    <label class="control-label" data-path="shadowCustom.opacity" data-desc-key="styling.shadowCustom.opacity">Opacity</label>
                                    <div class="control-input">
                                        <span class="value-display" id="shadow-opacity-value">0.4</span>
                                        <input type="range" id="shadow-opacity" min="0" max="1" step="0.05" value="0.4">
                                    </div>
                                </div>
                            </div>

                            <!-- Clip Path -->
                            <div class="control-row" data-property="clipPath">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-clipPath">
                                <label class="control-label" data-label="Clip Path" data-path="clipPath" data-desc-key="styling.clipPath">Clip Path</label>
                                <div class="control-input">
                                    <select id="style-clipPath" onchange="handleClipPathChange()">
                                        <option value="none" selected>None</option>
                                        <option value="circle">Circle</option>
                                        <option value="square">Square</option>
                                        <option value="triangle">Triangle</option>
                                        <option value="pentagon">Pentagon</option>
                                        <option value="hexagon">Hexagon</option>
                                        <option value="octagon">Octagon</option>
                                        <option value="diamond">Diamond</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Clip Path Mode (percent vs height-relative) -->
                            <div class="control-row" id="clippath-mode-row" style="display: none; margin-left: 20px;">
                                <label class="control-label" data-path="clipPathMode" data-desc-key="styling.clipPathMode">Mode</label>
                                <div class="control-input">
                                    <select id="style-clipPath-mode" onchange="handleClipPathModeChange()">
                                        <option value="percent">Percent</option>
                                        <option value="height-relative" selected>Height-relative</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Custom Clip Path Controls -->
                            <div class="custom-clippath-controls" id="custom-clippath-controls" style="display: none;">
                                <div class="control-row">
                                    <label class="control-label" data-path="clipPathCustom" data-desc-key="styling.clipPathCustom">Custom clip-path</label>
                                    <div class="control-input" style="display: flex; flex-direction: column; gap: 8px;">
                                        <textarea id="clippath-custom" placeholder="polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%)" style="width: 100%; height: 48px; padding: 8px; font-family: monospace; font-size: 12px; background: #2a2a3e; color: #e5e5e5; border: 1px solid #444; border-radius: 4px; resize: vertical;"></textarea>
                                        <div style="font-size: 12px; color: #aaa;">
                                            Quick fill:
                                            <a id="clippath-circle-btn" href="#" style="color: #8b5cf6; text-decoration: none; cursor: pointer; margin-right: 12px;">circle</a>
                                            <a id="clippath-square-btn" href="#" style="color: #8b5cf6; text-decoration: none; cursor: pointer; margin-right: 12px;">square</a>
                                            <a id="clippath-polygon-btn" href="#" style="color: #8b5cf6; text-decoration: none; cursor: pointer;">pentagon</a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Opacity -->
                            <div class="control-row" data-property="opacity">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-opacity">
                                <label class="control-label" data-label="Opacity" data-path="opacity" data-desc-key="styling.opacity">Opacity</label>
                                <div class="control-input">
                                    <span class="value-display">1</span>
                                    <input type="range" id="style-opacity" min="0" max="1" step="0.1" value="1" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>

                            <!-- Cursor -->
                            <div class="control-row" data-property="cursor">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-cursor">
                                <label class="control-label" data-label="Cursor" data-path="cursor" data-desc-key="styling.cursor">Cursor</label>
                                <div class="control-input">
                                    <select id="style-cursor">
                                        <option value="pointer" selected>pointer</option>
                                        <option value="auto">auto</option>
                                        <option value="default">default</option>
                                        <option value="grab">grab</option>
                                        <option value="grabbing">grabbing</option>
                                        <option value="move">move</option>
                                        <option value="crosshair">crosshair</option>
                                        <option value="text">text</option>
                                        <option value="wait">wait</option>
                                        <option value="progress">progress</option>
                                        <option value="not-allowed">not-allowed</option>
                                        <option value="help">help</option>
                                        <option value="zoom-in">zoom-in</option>
                                        <option value="zoom-out">zoom-out</option>
                                        <option value="none">none</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Invert -->
                            <div class="control-row" data-property="filter.invert">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-invert">
                                <label class="control-label" data-label="Invert" data-path="filter.invert" data-desc-key="styling.filter.invert">Invert</label>
                                <div class="control-input">
                                    <span class="value-display">0</span>
                                    <input type="range" id="style-invert" min="0" max="1" step="0.1" value="0" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>

                            <!-- Filters -->
                            <div class="control-row" data-property="filter.grayscale">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-grayscale">
                                <label class="control-label" data-label="Grayscale" data-path="filter.grayscale" data-desc-key="styling.filter.grayscale">Grayscale</label>
                                <div class="control-input">
                                    <span class="value-display">0</span>
                                    <input type="range" id="style-grayscale" min="0" max="1" step="0.1" value="0" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>
                            <div class="control-row" data-property="filter.blur">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-blur">
                                <label class="control-label" data-label="Blur" data-path="filter.blur" data-desc-key="styling.filter.blur">Blur</label>
                                <div class="control-input">
                                    <span class="value-display">0</span>
                                    <input type="range" id="style-blur" min="0" max="10" step="0.5" value="0" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>
                            <div class="control-row" data-property="filter.brightness">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-brightness">
                                <label class="control-label" data-label="Brightness" data-path="filter.brightness" data-desc-key="styling.filter.brightness">Brightness</label>
                                <div class="control-input">
                                    <span class="value-display">1</span>
                                    <input type="range" id="style-brightness" min="0.5" max="1.5" step="0.05" value="1" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>
                            <div class="control-row" data-property="filter.contrast">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-contrast">
                                <label class="control-label" data-label="Contrast" data-path="filter.contrast" data-desc-key="styling.filter.contrast">Contrast</label>
                                <div class="control-input">
                                    <span class="value-display">1</span>
                                    <input type="range" id="style-contrast" min="0.5" max="2" step="0.05" value="1" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>
                            <div class="control-row" data-property="filter.saturate">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-saturate">
                                <label class="control-label" data-label="Saturate" data-path="filter.saturate" data-desc-key="styling.filter.saturate">Saturate</label>
                                <div class="control-input">
                                    <span class="value-display">1</span>
                                    <input type="range" id="style-saturate" min="0" max="2" step="0.1" value="1" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>
                            <div class="control-row" data-property="filter.sepia">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-sepia">
                                <label class="control-label" data-label="Sepia" data-path="filter.sepia" data-desc-key="styling.filter.sepia">Sepia</label>
                                <div class="control-input">
                                    <span class="value-display">0</span>
                                    <input type="range" id="style-sepia" min="0" max="1" step="0.1" value="0" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>
                            <div class="control-row" data-property="filter.hueRotate">
                                <input type="checkbox" class="control-checkbox styling-checkbox" id="enable-style-hueRotate">
                                <label class="control-label" data-label="Hue Rotate" data-path="filter.hueRotate" data-desc-key="styling.filter.hueRotate">Hue Rotate</label>
                                <div class="control-input">
                                    <span class="value-display">0¬∞</span>
                                    <input type="range" id="style-hueRotate" min="0" max="360" step="10" value="0" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>

                            <!-- Clear Overrides Button (only for hover/focused) -->
                            <button type="button" class="clear-overrides-btn" id="clear-style-overrides" onclick="clearStyleOverrides()" disabled>
                                Clear Overrides
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Animation Section -->
                <div class="accordion" data-section="animation">
                    <div class="accordion-header" onclick="toggleAccordion(this.parentElement)">
                        <span class="accordion-title" data-label="Animation" data-path="animation" data-desc-key="animation">Animation</span>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <!-- General -->
                        <div class="control-group">
                            <h5 class="control-group-title" data-label="General" data-path="animation" data-desc-key="animation">General</h5>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-animation-duration">
                                <label class="control-label" data-label="Duration" data-path="duration" data-desc-key="animation.duration">Duration</label>
                                <div class="control-input">
                                    <input type="number" id="animation-duration" value="600" min="100" max="2000" step="50">
                                    <span class="value-display">ms</span>
                                </div>
                            </div>
                        </div>

                        <!-- Queue -->
                        <div class="control-group">
                            <h5 class="control-group-title" data-label="Queue" data-path="animation.queue" data-desc-key="animation.queue">Queue</h5>
                            <div class="subsection-toggle">
                                <input type="checkbox" id="enable-queue" checked onchange="toggleSubsection('queue-content', this.checked)">
                                <label for="enable-queue" data-label="Enabled" data-path="enabled" data-desc-key="animation.queue.enabled">Enabled</label>
                            </div>
                            <div class="subsection-content" id="queue-content">
                                <div class="control-row">
                                    <input type="checkbox" class="control-checkbox" id="enable-queue-interval">
                                    <label class="control-label" data-label="Interval" data-path="interval" data-desc-key="animation.queue.interval">Interval</label>
                                    <div class="control-input">
                                        <input type="number" id="queue-interval" value="150" min="0" max="500" step="25">
                                        <span class="value-display">ms</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Entry Animation -->
                        <div class="control-group">
                            <h5 class="control-group-title" data-label="Entry Animation" data-path="animation.entry" data-desc-key="animation.entry">Entry Animation</h5>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-entry-position">
                                <label class="control-label" data-label="Start Position" data-path="start.position" data-desc-key="animation.entry.start.position">Start Position</label>
                                <div class="control-input">
                                    <select id="entry-position">
                                        <option value="nearest-edge">Nearest Edge</option>
                                        <option value="top">Top</option>
                                        <option value="bottom">Bottom</option>
                                        <option value="left">Left</option>
                                        <option value="right">Right</option>
                                        <option value="center">Center</option>
                                        <option value="random-edge">Random Edge</option>
                                        <option value="circular">Circular</option>
                                    </select>
                                </div>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-entry-offset">
                                <label class="control-label" data-label="Offset" data-path="start.offset" data-desc-key="animation.entry.start.offset">Offset</label>
                                <div class="control-input">
                                    <input type="number" id="entry-offset" value="100" min="0" max="300">
                                    <span class="value-display">px</span>
                                </div>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-entry-duration">
                                <label class="control-label" data-label="Duration" data-path="timing.duration" data-desc-key="animation.entry.timing.duration">Duration</label>
                                <div class="control-input">
                                    <input type="number" id="entry-duration" value="600" min="100" max="2000" step="50">
                                    <span class="value-display">ms</span>
                                </div>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-entry-path">
                                <label class="control-label" data-label="Path Type" data-path="path.type" data-desc-key="animation.entry.path.type">Path Type</label>
                                <div class="control-input">
                                    <select id="entry-path-type" onchange="updatePathPresets()">
                                        <option value="linear">Linear (default)</option>
                                        <option value="bounce">Bounce</option>
                                        <option value="elastic">Elastic</option>
                                        <option value="wave">Wave</option>
                                    </select>
                                </div>
                            </div>
                            <div class="control-row" id="path-preset-row" style="display: none;">
                                <input type="checkbox" class="control-checkbox" id="enable-entry-path-preset" checked>
                                <label class="control-label" data-label="Preset" data-path="path.preset" data-desc-key="animation.entry.path.preset">Preset</label>
                                <div class="control-input">
                                    <select id="entry-path-preset">
                                        <!-- Options populated by updatePathPresets() -->
                                    </select>
                                </div>
                            </div>
                            <!-- Entry Rotation -->
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-entry-rotation">
                                <label class="control-label" data-label="Rotation Mode" data-path="rotation.mode" data-desc-key="animation.entry.rotation.mode">Rotation Mode</label>
                                <div class="control-input">
                                    <select id="entry-rotation-mode" onchange="updateRotationOptions()">
                                        <option value="none">None (default)</option>
                                        <option value="spin">Spin</option>
                                        <option value="settle">Settle</option>
                                        <option value="random">Random</option>
                                        <option value="wobble">Wobble</option>
                                    </select>
                                </div>
                            </div>
                            <div class="subsection-content" id="rotation-options-content">
                                <div class="control-row" id="spin-count-row" style="display: none;">
                                    <input type="checkbox" class="control-checkbox" id="enable-spin-count" checked>
                                    <label class="control-label" data-label="Spin Count" data-path="rotation.spinCount" data-desc-key="animation.entry.rotation.spinCount">Spin Count</label>
                                    <div class="control-input">
                                        <input type="number" id="entry-spin-count" value="1" min="1" max="5" step="1">
                                        <span class="value-display">rotations</span>
                                    </div>
                                </div>
                                <div class="control-row" id="spin-direction-row" style="display: none;">
                                    <input type="checkbox" class="control-checkbox" id="enable-spin-direction" checked>
                                    <label class="control-label" data-label="Direction" data-path="rotation.direction" data-desc-key="animation.entry.rotation.direction">Direction</label>
                                    <div class="control-input">
                                        <select id="entry-spin-direction">
                                            <option value="clockwise">Clockwise</option>
                                            <option value="counterclockwise">Counter-clockwise</option>
                                            <option value="auto">Auto</option>
                                            <option value="random">Random</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="control-row" id="settle-min-row" style="display: none;">
                                    <input type="checkbox" class="control-checkbox" id="enable-settle-range" checked>
                                    <label class="control-label" data-label="Start Range" data-path="rotation.startRotation" data-desc-key="animation.entry.rotation.startRotation">Start Range</label>
                                    <div class="control-input">
                                        <input type="number" id="entry-settle-min" value="-45" min="-180" max="0" step="5">
                                        <span class="value-display">to</span>
                                        <input type="number" id="entry-settle-max" value="45" min="0" max="180" step="5">
                                        <span class="value-display">deg</span>
                                    </div>
                                </div>
                                <div class="control-row" id="wobble-amplitude-row" style="display: none;">
                                    <input type="checkbox" class="control-checkbox" id="enable-wobble-config" checked>
                                    <label class="control-label" data-label="Wobble Amplitude" data-path="rotation.wobble.amplitude" data-desc-key="animation.entry.rotation.wobble.amplitude">Wobble Amplitude</label>
                                    <div class="control-input">
                                        <input type="number" id="entry-wobble-amplitude" value="15" min="5" max="45" step="5">
                                        <span class="value-display">deg</span>
                                    </div>
                                </div>
                                <div class="control-row" id="wobble-frequency-row" style="display: none;">
                                    <input type="checkbox" class="control-checkbox" id="enable-wobble-frequency" checked>
                                    <label class="control-label" data-label="Wobble Frequency" data-path="rotation.wobble.frequency" data-desc-key="animation.entry.rotation.wobble.frequency">Wobble Frequency</label>
                                    <div class="control-input">
                                        <input type="number" id="entry-wobble-frequency" value="3" min="1" max="8" step="1">
                                        <span class="value-display">oscillations</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Entry Scale -->
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-entry-scale">
                                <label class="control-label" data-label="Scale Mode" data-path="scale.mode" data-desc-key="animation.entry.scale.mode">Scale Mode</label>
                                <div class="control-input">
                                    <select id="entry-scale-mode" onchange="updateScaleOptions()">
                                        <option value="none">None (default)</option>
                                        <option value="grow">Grow</option>
                                        <option value="shrink">Shrink</option>
                                        <option value="pop">Pop</option>
                                        <option value="random">Random</option>
                                    </select>
                                </div>
                            </div>
                            <div class="subsection-content" id="scale-options-content">
                                <div class="control-row" id="scale-start-row" style="display: none;">
                                    <input type="checkbox" class="control-checkbox" id="enable-scale-start" checked>
                                    <label class="control-label" data-label="Start Scale" data-path="scale.startScale" data-desc-key="animation.entry.scale.startScale">Start Scale</label>
                                    <div class="control-input">
                                        <span class="value-display">0.3</span>
                                        <input type="range" id="entry-scale-start" min="0.1" max="4.0" step="0.1" value="0.3" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row" id="scale-pop-overshoot-row" style="display: none;">
                                    <input type="checkbox" class="control-checkbox" id="enable-pop-overshoot" checked>
                                    <label class="control-label" data-label="Pop Overshoot" data-path="scale.pop.overshoot" data-desc-key="animation.entry.scale.pop.overshoot">Pop Overshoot</label>
                                    <div class="control-input">
                                        <span class="value-display">1.2</span>
                                        <input type="range" id="entry-pop-overshoot" min="1.05" max="1.5" step="0.05" value="1.2" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                                <div class="control-row" id="scale-pop-bounces-row" style="display: none;">
                                    <input type="checkbox" class="control-checkbox" id="enable-pop-bounces" checked>
                                    <label class="control-label" data-label="Pop Bounces" data-path="scale.pop.bounces" data-desc-key="animation.entry.scale.pop.bounces">Pop Bounces</label>
                                    <div class="control-input">
                                        <input type="number" id="entry-pop-bounces" value="1" min="1" max="3" step="1">
                                        <span class="value-display">bounces</span>
                                    </div>
                                </div>
                                <div class="control-row" id="scale-random-min-row" style="display: none;">
                                    <input type="checkbox" class="control-checkbox" id="enable-scale-range" checked>
                                    <label class="control-label" data-label="Random Range" data-path="scale.range" data-desc-key="animation.entry.scale.range">Random Range</label>
                                    <div class="control-input">
                                        <span class="value-display">0.5</span>
                                        <input type="range" id="entry-scale-random-min" min="0.1" max="1.0" step="0.1" value="0.5" oninput="updateRangeDisplay(this)">
                                        <span class="value-display">to</span>
                                        <span class="value-display">1.0</span>
                                        <input type="range" id="entry-scale-random-max" min="0.5" max="4.0" step="0.1" value="1.0" oninput="updateRangeDisplay(this)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interaction Section -->
                <div class="accordion" data-section="interaction">
                    <div class="accordion-header" onclick="toggleAccordion(this.parentElement)">
                        <span class="accordion-title" data-label="Interaction" data-path="interaction" data-desc-key="interaction">Interaction</span>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <!-- Focus -->
                        <div class="control-group">
                            <h5 class="control-group-title" data-label="Focus Behavior" data-path="interaction.focus" data-desc-key="interaction.focus">Focus Behavior</h5>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-focus-scalePercent">
                                <label class="control-label" data-label="Scale %" data-path="scalePercent" data-desc-key="interaction.focus.scalePercent">Scale %</label>
                                <div class="control-input">
                                    <span class="value-display">0.8</span>
                                    <input type="range" id="focus-scalePercent" min="0.3" max="1.0" step="0.05" value="0.8" oninput="updateRangeDisplay(this)">
                                </div>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-focus-zIndex">
                                <label class="control-label" data-label="Z-Index" data-path="zIndex" data-desc-key="interaction.focus.zIndex">Z-Index</label>
                                <div class="control-input">
                                    <input type="number" id="focus-zIndex" value="1000" min="100" max="9999">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Config Section -->
                <div class="accordion" data-section="config">
                    <div class="accordion-header" onclick="toggleAccordion(this.parentElement)">
                        <span class="accordion-title" data-label="Config" data-path="config" data-desc-key="config">Config</span>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <!-- Loaders -->
                        <div class="control-group">
                            <h5 class="control-group-title" data-label="Loaders" data-path="config.loaders" data-desc-key="config.loaders">Loaders</h5>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-validate-urls">
                                <label class="control-label" data-label="Validate URLs" data-path="config.loaders.validateUrls" data-desc-key="config.loaders.validateUrls">Validate URLs</label>
                                <div class="control-input">
                                    <select id="config-validate-urls">
                                        <option value="true" selected>Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-validation-method">
                                <label class="control-label" data-label="Validation Method" data-path="config.loaders.validationMethod" data-desc-key="config.loaders.validationMethod">Validation Method</label>
                                <div class="control-input">
                                    <select id="config-validation-method">
                                        <option value="head" selected>Head</option>
                                        <option value="simple">Simple</option>
                                        <option value="none">None</option>
                                    </select>
                                </div>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-validation-timeout">
                                <label class="control-label" data-label="Validation Timeout" data-path="config.loaders.validationTimeout" data-desc-key="config.loaders.validationTimeout">Validation Timeout</label>
                                <div class="control-input">
                                    <input type="number" id="config-validation-timeout" value="5000" min="1000" max="30000" step="1000">
                                    <span class="value-display">ms</span>
                                </div>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="enable-allowed-extensions">
                                <label class="control-label" data-label="Allowed Extensions" data-path="config.loaders.allowedExtensions" data-desc-key="config.loaders.allowedExtensions">Allowed Extensions</label>
                                <div class="control-input">
                                    <input type="text" id="config-allowed-extensions" value="jpg,jpeg,png,gif,webp,bmp" style="width: 100%;">
                                </div>
                            </div>
                        </div>

                        <!-- Debug -->
                        <div class="control-group">
                            <h5 class="control-group-title" data-label="Debug" data-path="config.debug" data-desc-key="config.debug">Debug</h5>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="debug-enabled">
                                <label class="control-label" data-label="Enable debug logging" data-path="config.debug.enabled" data-desc-key="config.debug.enabled" style="flex: 0 0 auto;">Enable debug logging</label>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="debug-centers">
                                <label class="control-label" data-label="Show center markers" data-path="config.debug.centers" data-desc-key="config.debug.centers" style="flex: 0 0 auto;">Show center markers</label>
                            </div>
                            <div class="control-row">
                                <input type="checkbox" class="control-checkbox" id="debug-loaders">
                                <label class="control-label" data-label="Loader debug output" data-path="config.debug.loaders" data-desc-key="config.debug.loaders" style="flex: 0 0 auto;">Loader debug output</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="show-config-btn" onclick="showConfig()">Show Config JSON</button>
            </div>
        </aside>

        <main class="gallery-preview">
            <div class="gallery-container">
                <div id="imageCloud"></div>
            </div>
        </main>
    </div>

    <!-- Config Modal -->
    <div class="config-modal" id="configModal">
        <div class="config-content">
            <button class="close-btn" onclick="hideConfig()">&times;</button>
            <h4>Generated Configuration</h4>
            <pre id="configOutput"></pre>
            <div class="config-options">
                <button class="copy-btn" onclick="copyConfig()">Copy to Clipboard</button>
                <label>
                    <input type="checkbox" id="singleLineJson" onchange="updateConfigDisplay()">
                    Single line JSON
                </label>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="help-modal" id="helpModal">
        <div class="help-content">
            <button class="close-btn" onclick="hideHelp()">&times;</button>
            <h4>How to Use</h4>
            <p>This configurator lets you visually customize your Image Cloud gallery and generate the JSON configuration.</p>
            <ul>
                <li><strong>Presets:</strong> Start with a preset to quickly apply common styles</li>
                <li><strong>Checkboxes:</strong> Enable settings to include them in the config</li>
                <li><strong>Eye Toggle:</strong> Switch between friendly labels and JSON paths</li>
                <li><strong>Show Config JSON:</strong> View and copy the generated config</li>
            </ul>
            <p>Only enabled (checked) settings are included in the generated configuration.</p>
        </div>
    </div>

    <script src="../dist/image-cloud.umd.js"></script>
    <script>
        // UMD build exports to window.ImageCloud as an object with class as ImageCloud
        const { ImageCloud } = window.ImageCloud;

        let gallery = null;
        let showingPaths = false;
        let debounceTimer = null;
        let lastAppliedConfig = null;

        // Styling state management
        let currentStylingState = 'default';
        let currentBorderSide = 'all'; // 'all', 'top', 'right', 'bottom', 'left'
        let currentBorderRadiusCorner = 'all'; // 'all', 'ul', 'ur', 'br', 'bl'

        // Default values for each property
        const styleDefaults = {
            'border.width': 0,
            'border.color': '#000000',
            'border.style': 'solid',
            'border.radius': 0,
            // Per-corner border radius (null means inherit from 'border.radius')
            'borderRadiusTopLeft': null,
            'borderRadiusTopRight': null,
            'borderRadiusBottomRight': null,
            'borderRadiusBottomLeft': null,
            // Per-side border properties (null means inherit from 'border')
            'borderTop.width': null,
            'borderTop.color': null,
            'borderTop.style': null,
            'borderRight.width': null,
            'borderRight.color': null,
            'borderRight.style': null,
            'borderBottom.width': null,
            'borderBottom.color': null,
            'borderBottom.style': null,
            'borderLeft.width': null,
            'borderLeft.color': null,
            'borderLeft.style': null,
            // Outline properties
            'outline.width': 0,
            'outline.color': '#000000',
            'outline.style': 'solid',
            'outline.offset': 0,
            'shadow': 'none',
            'clipPath': 'none',
            'opacity': 1,
            'cursor': 'pointer',
            'filter.grayscale': 0,
            'filter.blur': 0,
            'filter.brightness': 1,
            'filter.contrast': 1,
            'filter.saturate': 1,
            'filter.sepia': 0,
            'filter.hueRotate': 0,
            'filter.invert': 0
        };

        // Per-state styling configuration
        // Each state tracks: { enabled: boolean, value: any } for each property
        const stylingState = {
            default: {},
            hover: {},
            focused: {}
        };

        // Initialize styling state with defaults for 'default' state
        function initStylingState() {
            for (const prop of Object.keys(styleDefaults)) {
                stylingState.default[prop] = { enabled: false, value: styleDefaults[prop] };
                stylingState.hover[prop] = { enabled: false, value: styleDefaults[prop] };
                stylingState.focused[prop] = { enabled: false, value: styleDefaults[prop] };
            }
            // Initialize custom shadow state for each state
            initCustomShadowState();
        }

        // Custom shadow state per styling state
        const customShadowState = {
            default: { offsetX: 0, offsetY: 4, blur: 16, color: '#000000', opacity: 0.4 },
            hover: { offsetX: 0, offsetY: 4, blur: 16, color: '#000000', opacity: 0.4 },
            focused: { offsetX: 0, offsetY: 4, blur: 16, color: '#000000', opacity: 0.4 }
        };

        // Initialize custom shadow state
        function initCustomShadowState() {
            const defaultCustom = { offsetX: 0, offsetY: 4, blur: 16, color: '#000000', opacity: 0.4 };
            customShadowState.default = { ...defaultCustom };
            customShadowState.hover = { ...defaultCustom };
            customShadowState.focused = { ...defaultCustom };
        }

        // Custom clip path state per styling state
        const customClipPathState = {
            default: '',
            hover: '',
            focused: ''
        };

        // Shadow preset definitions (for copying values to custom)
        const shadowPresets = {
            'none': { offsetX: 0, offsetY: 0, blur: 0, color: '#000000', opacity: 0 },
            'sm': { offsetX: 0, offsetY: 2, blur: 4, color: '#000000', opacity: 0.1 },
            'md': { offsetX: 0, offsetY: 4, blur: 16, color: '#000000', opacity: 0.4 },
            'lg': { offsetX: 0, offsetY: 8, blur: 32, color: '#000000', opacity: 0.5 },
            'glow': { offsetX: 0, offsetY: 0, blur: 30, color: '#ffffff', opacity: 0.6 }
        };

        // Parse shadow preset to custom values
        function parseShadowPreset(presetName) {
            return shadowPresets[presetName] || shadowPresets['md'];
        }

        // Convert hex color to rgba
        function hexToRgba(hex, opacity) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (!result) return `rgba(0, 0, 0, ${opacity})`;
            const r = parseInt(result[1], 16);
            const g = parseInt(result[2], 16);
            const b = parseInt(result[3], 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }

        // Build custom shadow CSS string
        function buildCustomShadow(params) {
            const { offsetX, offsetY, blur, color, opacity } = params;
            const rgba = hexToRgba(color, opacity);
            return `${offsetX}px ${offsetY}px ${blur}px ${rgba}`;
        }

        // Get effective value for a property (considers inheritance)
        function getEffectiveValue(state, property) {
            if (stylingState[state][property]?.enabled) {
                return stylingState[state][property].value;
            }
            if (state !== 'default' && stylingState.default[property]?.enabled) {
                return stylingState.default[property].value;
            }
            return styleDefaults[property];
        }

        // Check if a property is inherited (not explicitly set for this state)
        function isInherited(state, property) {
            return state !== 'default' && !stylingState[state][property]?.enabled;
        }

        // Select styling state
        window.selectStylingState = function(state) {
            currentStylingState = state;

            // Update selector buttons
            document.querySelectorAll('.state-selector-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.state === state);
            });

            // Update clear overrides button
            const clearBtn = document.getElementById('clear-style-overrides');
            clearBtn.disabled = state === 'default';

            // Update path prefix
            const stylingPrefix = document.getElementById('styling-path-prefix');
            if (stylingPrefix) {
                stylingPrefix.textContent = `styling.${state}`;
            }

            // Populate form with state values
            populateStylingForm(state);
        };

        // Get border property prefix based on current side
        function getBorderPropertyPrefix(side) {
            if (side === 'all') return 'border';
            return 'border' + side.charAt(0).toUpperCase() + side.slice(1);
        }

        // Get the actual property key for border controls based on current side
        function getBorderProperty(baseProp, side) {
            if (!baseProp.startsWith('border.') || baseProp === 'border.radius') {
                return baseProp; // Not a border side property
            }
            const subProp = baseProp.replace('border.', '');
            if (side === 'all') return baseProp;
            return getBorderPropertyPrefix(side) + '.' + subProp;
        }

        // Select border side
        window.selectBorderSide = function(side) {
            currentBorderSide = side;

            // Update selector buttons
            document.querySelectorAll('#border-side-selector .side-selector-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.side === side);
            });

            // Update path display for border controls
            updateBorderControlPaths(side);

            // Populate border controls with values for this side
            populateBorderControls(currentStylingState, side);

            // Show/hide outline controls (only visible when "All" is selected)
            const outlineWrapper = document.getElementById('outline-controls-wrapper');
            if (outlineWrapper) {
                outlineWrapper.style.display = side === 'all' ? '' : 'none';
            }
        };

        // Update data-path attributes for border controls based on current side
        function updateBorderControlPaths(side) {
            const prefix = getBorderPropertyPrefix(side);
            const borderProps = ['width', 'color', 'style'];

            borderProps.forEach(prop => {
                const row = document.querySelector(`[data-property="border.${prop}"]`);
                if (row) {
                    const label = row.querySelector('.control-label');
                    if (label) {
                        label.dataset.path = `${prefix}.${prop}`;
                        // Update visible text if paths are showing
                        if (showingPaths) {
                            label.textContent = `${prefix}.${prop}`;
                        }
                    }
                }
            });
        }

        // Populate border controls with values for the specified side
        function populateBorderControls(state, side) {
            const borderProps = ['width', 'color', 'style'];

            borderProps.forEach(baseProp => {
                const htmlProperty = `border.${baseProp}`;
                const actualProperty = getBorderProperty(htmlProperty, side);

                const row = document.querySelector(`[data-property="${htmlProperty}"]`);
                if (!row) return;

                const checkbox = row.querySelector('.styling-checkbox');
                const controlId = checkbox?.id.replace('enable-', '');
                const control = document.getElementById(controlId);

                if (!checkbox || !control) return;

                const stateData = stylingState[state][actualProperty];

                // Get effective value: check this side, then 'all' side, then default
                let effectiveValue;
                if (stateData?.enabled) {
                    effectiveValue = stateData.value;
                } else if (side !== 'all' && stylingState[state][`border.${baseProp}`]?.enabled) {
                    effectiveValue = stylingState[state][`border.${baseProp}`].value;
                } else if (state !== 'default') {
                    // Check default state
                    if (stylingState.default[actualProperty]?.enabled) {
                        effectiveValue = stylingState.default[actualProperty].value;
                    } else if (side !== 'all' && stylingState.default[`border.${baseProp}`]?.enabled) {
                        effectiveValue = stylingState.default[`border.${baseProp}`].value;
                    } else {
                        effectiveValue = styleDefaults[`border.${baseProp}`];
                    }
                } else {
                    effectiveValue = styleDefaults[`border.${baseProp}`];
                }

                // Set checkbox state for this specific side property
                checkbox.checked = stateData?.enabled || false;

                // Set control value
                control.value = effectiveValue;

                // Update visual state
                const inherited = state !== 'default' && !stateData?.enabled;
                row.classList.toggle('disabled', !checkbox.checked);
                row.classList.toggle('inherited', inherited && !checkbox.checked);
            });
        }

        // Get border radius property name based on corner
        function getBorderRadiusProperty(corner) {
            const cornerMap = {
                'all': 'border.radius',
                'ul': 'borderRadiusTopLeft',
                'ur': 'borderRadiusTopRight',
                'br': 'borderRadiusBottomRight',
                'bl': 'borderRadiusBottomLeft'
            };
            return cornerMap[corner] || 'border.radius';
        }

        // Get display path for border radius based on corner
        function getBorderRadiusPath(corner) {
            const pathMap = {
                'all': 'border.radius',
                'ul': 'borderRadiusTopLeft',
                'ur': 'borderRadiusTopRight',
                'br': 'borderRadiusBottomRight',
                'bl': 'borderRadiusBottomLeft'
            };
            return pathMap[corner] || 'border.radius';
        }

        // Select border radius corner
        window.selectBorderRadiusCorner = function(corner) {
            currentBorderRadiusCorner = corner;

            // Update selector buttons
            document.querySelectorAll('#border-radius-corner-selector .side-selector-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.corner === corner);
            });

            // Update path display for border radius control
            updateBorderRadiusControlPath(corner);

            // Populate border radius control with value for this corner
            populateBorderRadiusControl(currentStylingState, corner);
        };

        // Update data-path attribute for border radius control
        function updateBorderRadiusControlPath(corner) {
            const path = getBorderRadiusPath(corner);
            const row = document.querySelector('[data-property="border.radius"]');
            if (row) {
                const label = row.querySelector('.control-label');
                if (label) {
                    label.dataset.path = path;
                    if (showingPaths) {
                        label.textContent = path;
                    }
                }
            }
        }

        // Populate border radius control with value for the specified corner
        function populateBorderRadiusControl(state, corner) {
            const actualProperty = getBorderRadiusProperty(corner);
            const row = document.querySelector('[data-property="border.radius"]');
            if (!row) return;

            const checkbox = row.querySelector('.styling-checkbox');
            const control = document.getElementById('style-border-radius');

            if (!checkbox || !control) return;

            const stateData = stylingState[state][actualProperty];

            // Get effective value: check this corner, then 'all' corners, then default
            let effectiveValue;
            if (stateData?.enabled) {
                effectiveValue = stateData.value;
            } else if (corner !== 'all' && stylingState[state]['border.radius']?.enabled) {
                effectiveValue = stylingState[state]['border.radius'].value;
            } else if (state !== 'default') {
                // Check default state
                if (stylingState.default[actualProperty]?.enabled) {
                    effectiveValue = stylingState.default[actualProperty].value;
                } else if (corner !== 'all' && stylingState.default['border.radius']?.enabled) {
                    effectiveValue = stylingState.default['border.radius'].value;
                } else {
                    effectiveValue = styleDefaults['border.radius'];
                }
            } else {
                effectiveValue = styleDefaults['border.radius'];
            }

            // Set checkbox state for this specific corner property
            checkbox.checked = stateData?.enabled || false;

            // Set control value
            control.value = effectiveValue;

            // Update visual state
            const inherited = state !== 'default' && !stateData?.enabled;
            row.classList.toggle('disabled', !checkbox.checked);
            row.classList.toggle('inherited', inherited && !checkbox.checked);
        }

        // Populate form with values for the selected state
        function populateStylingForm(state) {
            const controls = document.querySelectorAll('#styling-controls .control-row');

            // Border side properties and radius are handled separately
            const specialBorderProps = ['border.width', 'border.color', 'border.style', 'border.radius'];

            controls.forEach(row => {
                const property = row.dataset.property;
                if (!property) return;

                // Skip special border properties - handled separately
                if (specialBorderProps.includes(property)) return;

                const checkbox = row.querySelector('.styling-checkbox');
                const controlId = checkbox?.id.replace('enable-', '');
                const control = document.getElementById(controlId);

                if (!checkbox || !control) return;

                const stateData = stylingState[state][property];
                const effectiveValue = getEffectiveValue(state, property);
                const inherited = isInherited(state, property);

                // Set checkbox state
                checkbox.checked = stateData?.enabled || false;

                // Set control value
                control.value = effectiveValue;

                // Update range display if applicable
                if (control.type === 'range') {
                    const display = control.parentElement?.querySelector('.value-display');
                    if (display) {
                        display.textContent = property === 'filter.hueRotate' ? effectiveValue + '¬∞' : effectiveValue;
                    }
                }

                // Update visual state
                row.classList.toggle('disabled', !checkbox.checked);
                row.classList.toggle('inherited', inherited && !checkbox.checked);
            });

            // Populate border controls based on current side
            populateBorderControls(state, currentBorderSide);

            // Populate border radius control based on current corner
            populateBorderRadiusControl(state, currentBorderRadiusCorner);

            // Populate custom shadow controls
            populateCustomShadowState(state);

            // Populate custom clip path controls
            populateCustomClipPathState(state);
        }

        // Populate custom shadow controls based on state
        function populateCustomShadowState(state) {
            const shadowSelect = document.getElementById('style-shadow');
            const customControls = document.getElementById('custom-shadow-controls');
            const effectiveValue = getEffectiveValue(state, 'shadow');

            // Show/hide custom controls based on current value
            const isCustom = effectiveValue === 'custom' || (effectiveValue && !shadowPresets[effectiveValue] && effectiveValue !== 'none');
            customControls.style.display = isCustom ? 'block' : 'none';

            // If it's a custom CSS string (not a preset), set select to custom
            if (isCustom && shadowSelect.value !== 'custom') {
                shadowSelect.value = 'custom';
            }

            // Update the tracked previous value for preset-to-custom copying
            previousShadowValue = shadowSelect.value;

            // Populate the custom shadow control values
            populateCustomShadowControls(state);
        }

        // Handle styling checkbox change
        function onStylingCheckboxChange(checkbox) {
            const row = checkbox.closest('.control-row');
            const htmlProperty = row?.dataset.property;
            if (!htmlProperty) return;

            // Get the actual property key (handles border side and corner selection)
            let actualProperty;
            if (htmlProperty === 'border.radius') {
                actualProperty = getBorderRadiusProperty(currentBorderRadiusCorner);
            } else {
                actualProperty = getBorderProperty(htmlProperty, currentBorderSide);
            }

            const controlId = checkbox.id.replace('enable-', '');
            const control = document.getElementById(controlId);

            // Get default value for the base property
            const defaultValue = styleDefaults['border.radius'] !== undefined && htmlProperty === 'border.radius'
                ? styleDefaults['border.radius']
                : (styleDefaults[htmlProperty.replace(/^border(Top|Right|Bottom|Left)\./, 'border.')] ?? styleDefaults[htmlProperty]);

            stylingState[currentStylingState][actualProperty] = {
                enabled: checkbox.checked,
                value: control ? (control.type === 'range' ? parseFloat(control.value) :
                       control.type === 'number' ? parseInt(control.value) : control.value) : defaultValue
            };

            row.classList.toggle('disabled', !checkbox.checked);
            row.classList.toggle('inherited', isInherited(currentStylingState, actualProperty) && !checkbox.checked);

            scheduleAutoApply();
        }

        // Handle styling control value change
        function onStylingControlChange(control) {
            const row = control.closest('.control-row');
            const htmlProperty = row?.dataset.property;
            if (!htmlProperty) return;

            // Get the actual property key (handles border side and corner selection)
            let actualProperty;
            if (htmlProperty === 'border.radius') {
                actualProperty = getBorderRadiusProperty(currentBorderRadiusCorner);
            } else {
                actualProperty = getBorderProperty(htmlProperty, currentBorderSide);
            }

            const checkbox = row.querySelector('.styling-checkbox');
            if (!checkbox?.checked) return;

            stylingState[currentStylingState][actualProperty] = {
                enabled: true,
                value: control.type === 'range' ? parseFloat(control.value) :
                       control.type === 'number' ? parseInt(control.value) : control.value
            };

            scheduleAutoApply();
        }

        // Clear all overrides for current state (hover/focused only)
        window.clearStyleOverrides = function() {
            if (currentStylingState === 'default') return;

            for (const prop of Object.keys(styleDefaults)) {
                stylingState[currentStylingState][prop] = {
                    enabled: false,
                    value: styleDefaults[prop]
                };
            }

            // Reset custom shadow state for this state
            customShadowState[currentStylingState] = { offsetX: 0, offsetY: 4, blur: 16, color: '#000000', opacity: 0.4 };

            // Reset custom clip path state for this state
            customClipPathState[currentStylingState] = '';

            populateStylingForm(currentStylingState);
            scheduleAutoApply();
        };

        // Setup styling control listeners
        function setupStylingListeners() {
            // Checkbox listeners
            document.querySelectorAll('.styling-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => onStylingCheckboxChange(checkbox));
            });

            // Control value listeners
            document.querySelectorAll('#styling-controls input:not(.styling-checkbox), #styling-controls select').forEach(control => {
                const eventType = control.type === 'range' ? 'input' : 'change';
                control.addEventListener(eventType, () => onStylingControlChange(control));
            });

            // Custom shadow controls setup
            setupCustomShadowControls();

            // Custom clip path controls setup
            setupCustomClipPathControls();
        }

        // Track shadow select value before changes (updated by populateCustomShadowState)
        let previousShadowValue = 'none';

        // Setup custom shadow controls
        function setupCustomShadowControls() {
            const shadowSelect = document.getElementById('style-shadow');
            const customControls = document.getElementById('custom-shadow-controls');

            // Track value before change using mousedown (fires before change)
            shadowSelect.addEventListener('mousedown', function() {
                previousShadowValue = this.value;
            });

            // Toggle custom controls visibility when shadow select changes
            shadowSelect.addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                customControls.style.display = isCustom ? 'block' : 'none';

                if (isCustom) {
                    // If switching to custom from a preset, copy preset values
                    if (previousShadowValue && previousShadowValue !== 'custom' && shadowPresets[previousShadowValue]) {
                        const presetValues = parseShadowPreset(previousShadowValue);
                        customShadowState[currentStylingState] = { ...presetValues };
                        populateCustomShadowControls(currentStylingState);
                    }
                }
                previousShadowValue = this.value;
            });

            // Custom shadow control listeners
            const customInputs = ['shadow-offset-x', 'shadow-offset-y', 'shadow-blur', 'shadow-color', 'shadow-opacity'];
            customInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    const eventType = input.type === 'range' ? 'input' : 'change';
                    input.addEventListener(eventType, () => onCustomShadowChange());
                }
            });

            // Update opacity display value
            const opacitySlider = document.getElementById('shadow-opacity');
            if (opacitySlider) {
                opacitySlider.addEventListener('input', function() {
                    document.getElementById('shadow-opacity-value').textContent = this.value;
                });
            }
        }

        // Handle custom shadow control changes
        function onCustomShadowChange() {
            const checkbox = document.getElementById('enable-style-shadow');
            if (!checkbox?.checked) return;

            const shadowSelect = document.getElementById('style-shadow');
            if (shadowSelect.value !== 'custom') return;

            // Update custom shadow state for current styling state
            customShadowState[currentStylingState] = {
                offsetX: parseInt(document.getElementById('shadow-offset-x').value) || 0,
                offsetY: parseInt(document.getElementById('shadow-offset-y').value) || 0,
                blur: parseInt(document.getElementById('shadow-blur').value) || 0,
                color: document.getElementById('shadow-color').value || '#000000',
                opacity: parseFloat(document.getElementById('shadow-opacity').value) || 0
            };

            // Update styling state with custom shadow CSS
            stylingState[currentStylingState].shadow = {
                enabled: true,
                value: 'custom'
            };

            scheduleAutoApply();
        }

        // Populate custom shadow controls from state
        function populateCustomShadowControls(state) {
            const custom = customShadowState[state];
            document.getElementById('shadow-offset-x').value = custom.offsetX;
            document.getElementById('shadow-offset-y').value = custom.offsetY;
            document.getElementById('shadow-blur').value = custom.blur;
            document.getElementById('shadow-color').value = custom.color;
            document.getElementById('shadow-opacity').value = custom.opacity;
            document.getElementById('shadow-opacity-value').textContent = custom.opacity;
        }

        // Handle clip path select change
        window.handleClipPathChange = function() {
            const clipPathSelect = document.getElementById('style-clipPath');
            const customControls = document.getElementById('custom-clippath-controls');
            const modeRow = document.getElementById('clippath-mode-row');
            const isCustom = clipPathSelect.value === 'custom';
            const isNone = clipPathSelect.value === 'none';

            customControls.style.display = isCustom ? 'block' : 'none';
            // Show mode toggle only for predefined shapes (not custom or none)
            if (modeRow) {
                modeRow.style.display = !isCustom && !isNone ? 'flex' : 'none';
            }

            if (!isCustom) {
                // For predefined shapes, update the styling state
                const checkbox = document.getElementById('enable-style-clipPath');
                if (checkbox?.checked) {
                    const modeSelect = document.getElementById('style-clipPath-mode');
                    const mode = modeSelect?.value || 'percent';
                    stylingState[currentStylingState].clipPath = {
                        enabled: true,
                        value: clipPathSelect.value,
                        mode: mode
                    };
                    scheduleAutoApply();
                }
            }
        };

        // Handle clip path mode change
        window.handleClipPathModeChange = function() {
            const checkbox = document.getElementById('enable-style-clipPath');
            const clipPathSelect = document.getElementById('style-clipPath');
            const modeSelect = document.getElementById('style-clipPath-mode');

            // Update whenever mode changes and clip path is enabled
            if (checkbox?.checked) {
                const clipPathValue = clipPathSelect?.value;
                const mode = modeSelect?.value || 'percent';

                // Update the stored state
                if (!stylingState[currentStylingState].clipPath) {
                    stylingState[currentStylingState].clipPath = { enabled: true };
                }

                stylingState[currentStylingState].clipPath.value = clipPathValue;
                stylingState[currentStylingState].clipPath.mode = mode;
                stylingState[currentStylingState].clipPath.enabled = true;

                scheduleAutoApply();
            }
        };

        // Handle custom clip path input
        function onCustomClipPathChange() {
            const checkbox = document.getElementById('enable-style-clipPath');
            if (!checkbox?.checked) return;

            const customInput = document.getElementById('clippath-custom');
            const customValue = customInput.value.trim();

            if (customValue) {
                stylingState[currentStylingState].clipPath = {
                    enabled: true,
                    value: customValue
                };
                scheduleAutoApply();
            }
        }

        // Setup custom clip path controls
        function setupCustomClipPathControls() {
            const clipPathSelect = document.getElementById('style-clipPath');
            const modeSelect = document.getElementById('style-clipPath-mode');
            const customInput = document.getElementById('clippath-custom');

            if (clipPathSelect) {
                clipPathSelect.addEventListener('change', handleClipPathChange);
            }

            if (modeSelect) {
                modeSelect.addEventListener('change', handleClipPathModeChange);
            }

            if (customInput) {
                customInput.addEventListener('change', onCustomClipPathChange);
                customInput.addEventListener('input', onCustomClipPathChange);
            }

            // Setup quick-fill links for common clip-path shapes
            const circleBtn = document.getElementById('clippath-circle-btn');
            const squareBtn = document.getElementById('clippath-square-btn');
            const polygonBtn = document.getElementById('clippath-polygon-btn');

            if (circleBtn) {
                circleBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    customInput.value = 'circle(50%)';
                    onCustomClipPathChange();
                });
            }

            if (squareBtn) {
                squareBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    customInput.value = 'polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%)';
                    onCustomClipPathChange();
                });
            }

            if (polygonBtn) {
                polygonBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    customInput.value = 'polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%)';
                    onCustomClipPathChange();
                });
            }
        }

        // Populate custom clip path controls based on state
        function populateCustomClipPathState(state) {
            const clipPathSelect = document.getElementById('style-clipPath');
            const modeSelect = document.getElementById('style-clipPath-mode');
            const modeRow = document.getElementById('clippath-mode-row');
            const customControls = document.getElementById('custom-clippath-controls');
            const customInput = document.getElementById('clippath-custom');
            const effectiveValue = getEffectiveValue(state, 'clipPath');

            if (!clipPathSelect) return;

            // Determine if this is a custom clip-path string
            const predefinedShapes = ['none', 'circle', 'square', 'triangle', 'pentagon', 'hexagon', 'octagon', 'diamond'];
            const isCustom = effectiveValue && !predefinedShapes.includes(effectiveValue);

            // Set the select value
            if (isCustom) {
                clipPathSelect.value = 'custom';
                customControls.style.display = 'block';
                if (modeRow) modeRow.style.display = 'none';
                if (customInput) {
                    customInput.value = effectiveValue || '';
                }
                customClipPathState[state] = effectiveValue || '';
            } else {
                const isNone = effectiveValue === 'none' || !effectiveValue;
                clipPathSelect.value = effectiveValue || 'none';
                customControls.style.display = 'none';
                // Show mode toggle for predefined shapes (not custom or none)
                if (modeRow) {
                    modeRow.style.display = !isNone ? 'flex' : 'none';
                }
                if (customInput) {
                    customInput.value = '';
                }
                customClipPathState[state] = '';

                // Restore clip-path mode from stored state
                if (modeSelect) {
                    const clipPathData = stylingState[state]?.clipPath;
                    const mode = clipPathData?.mode || 'percent';
                    modeSelect.value = mode;
                }
            }
        }

        // Field descriptions for tooltips
        let fieldDescriptions = {};

        async function loadFieldDescriptions() {
            try {
                const response = await fetch('field-descriptions.json');
                fieldDescriptions = await response.json();
                initTooltips();
            } catch (error) {
                console.warn('Could not load field descriptions:', error);
            }
        }

        function getDescription(path) {
            // Navigate the nested object using dot notation path
            const parts = path.split('.');
            let current = fieldDescriptions;
            for (const part of parts) {
                if (current && typeof current === 'object' && part in current) {
                    current = current[part];
                } else {
                    return null;
                }
            }
            // Return string value, or _title for objects
            return typeof current === 'string' ? current : current?._title || null;
        }

        function initTooltips() {
            const labels = document.querySelectorAll('[data-desc-key]');
            let activeTooltip = null;

            function showTooltip(element) {
                hideTooltip();
                const path = element.getAttribute('data-desc-key');
                const description = getDescription(path);
                if (!description) return;

                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = description;

                // Position relative to label
                element.style.position = 'relative';
                element.appendChild(tooltip);
                activeTooltip = { element, tooltip };
            }

            function hideTooltip() {
                if (activeTooltip) {
                    activeTooltip.tooltip.remove();
                    activeTooltip = null;
                }
            }

            labels.forEach(label => {
                // Desktop: mouse events
                label.addEventListener('mouseenter', () => showTooltip(label));
                label.addEventListener('mouseleave', hideTooltip);

                // Mobile: tap to toggle
                label.addEventListener('touchstart', (e) => {
                    if (activeTooltip?.element === label) {
                        hideTooltip();
                    } else {
                        e.preventDefault();
                        showTooltip(label);
                    }
                }, { passive: false });
            });

            // Mobile: tap elsewhere to hide
            document.addEventListener('touchstart', (e) => {
                if (activeTooltip && !activeTooltip.element.contains(e.target)) {
                    hideTooltip();
                }
            });
        }

        // Sample images
        // Pool of 50 images from Pexels (nature/landscape photos) at 1600px for sharp zoom
        const imagePool = [
            'https://images.pexels.com/photos/1266810/pexels-photo-1266810.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/417074/pexels-photo-417074.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1287460/pexels-photo-1287460.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1054218/pexels-photo-1054218.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/2662116/pexels-photo-2662116.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/3225517/pexels-photo-3225517.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1525041/pexels-photo-1525041.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1450082/pexels-photo-1450082.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1619317/pexels-photo-1619317.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1366919/pexels-photo-1366919.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1761279/pexels-photo-1761279.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1287145/pexels-photo-1287145.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/2387873/pexels-photo-2387873.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1668928/pexels-photo-1668928.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1591382/pexels-photo-1591382.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1485894/pexels-photo-1485894.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1166209/pexels-photo-1166209.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1659438/pexels-photo-1659438.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/2559941/pexels-photo-2559941.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1903702/pexels-photo-1903702.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1640777/pexels-photo-1640777.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1433052/pexels-photo-1433052.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/2325446/pexels-photo-2325446.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/2440061/pexels-photo-2440061.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/2104152/pexels-photo-2104152.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1624496/pexels-photo-1624496.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1179229/pexels-photo-1179229.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/3225517/pexels-photo-3225517.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1591373/pexels-photo-1591373.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1366630/pexels-photo-1366630.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1402850/pexels-photo-1402850.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1183099/pexels-photo-1183099.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1323550/pexels-photo-1323550.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1212600/pexels-photo-1212600.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1693095/pexels-photo-1693095.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1547813/pexels-photo-1547813.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1612351/pexels-photo-1612351.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1552212/pexels-photo-1552212.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1435752/pexels-photo-1435752.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1687845/pexels-photo-1687845.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1647962/pexels-photo-1647962.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1535162/pexels-photo-1535162.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1671324/pexels-photo-1671324.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1643409/pexels-photo-1643409.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1662298/pexels-photo-1662298.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1581384/pexels-photo-1581384.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1578750/pexels-photo-1578750.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1658967/pexels-photo-1658967.jpeg?auto=compress&cs=tinysrgb&w=1600',
            'https://images.pexels.com/photos/1545505/pexels-photo-1545505.jpeg?auto=compress&cs=tinysrgb&w=1600'
        ];

        // Get the selected number of images
        function getSelectedImages() {
            const count = parseInt(document.getElementById('imageCount').value);
            // If count > pool size, repeat images
            const images = [];
            for (let i = 0; i < count; i++) {
                images.push(imagePool[i % imagePool.length]);
            }
            return images;
        }

        // Update image count display and refresh gallery
        window.updateImageCount = function(input) {
            document.getElementById('imageCountValue').textContent = input.value;
            scheduleAutoApply();
        };

        // Presets
        const presets = {
            'default': {
                name: 'Default',
                description: 'Library defaults - minimal configuration',
                config: {}
            },
            'scattered-photos': {
                name: 'Scattered Photos',
                description: 'Classic scattered look with rotation',
                config: {
                    'layout-algorithm': 'radial',
                    'image-rotation-mode': 'random',
                    'enable-image-rotation-mode': true,
                    'image-rotation-min': -15,
                    'image-rotation-max': 15,
                    'enable-image-rotation-min': true,
                    'enable-image-rotation-max': true,
                    'default-shadow': 'md',
                    'enable-default-shadow': true,
                    'default-border-radius': 4,
                    'enable-default-border-radius': true
                }
            },
            'clean-grid': {
                name: 'Clean Grid',
                description: 'Organized grid layout without rotation',
                config: {
                    'layout-algorithm': 'grid',
                    'enable-algorithm': true,
                    'image-rotation-mode': 'none',
                    'enable-image-rotation-mode': true,
                    'grid-columns': 4,
                    'enable-grid-columns': true,
                    'default-shadow': 'sm',
                    'enable-default-shadow': true,
                    'default-border-radius': 8,
                    'enable-default-border-radius': true
                }
            },
            'polaroid': {
                name: 'Polaroid',
                description: 'White borders, warm filter tones',
                config: {
                    'layout-algorithm': 'radial',
                    'image-rotation-mode': 'random',
                    'enable-image-rotation-mode': true,
                    'image-rotation-min': -12,
                    'image-rotation-max': 12,
                    'enable-image-rotation-min': true,
                    'enable-image-rotation-max': true,
                    'default-border-width': 8,
                    'enable-default-border-width': true,
                    'default-border-color': '#ffffff',
                    'enable-default-border-color': true,
                    'default-border-radius': 2,
                    'enable-default-border-radius': true,
                    'default-shadow': 'md',
                    'enable-default-shadow': true,
                    'default-sepia': 0.1,
                    'enable-default-sepia': true,
                    'default-contrast': 1.05,
                    'enable-default-contrast': true
                }
            },
            'vintage': {
                name: 'Vintage',
                description: 'Sepia tones, reduced saturation',
                config: {
                    'layout-algorithm': 'radial',
                    'image-rotation-mode': 'random',
                    'enable-image-rotation-mode': true,
                    'image-rotation-min': -8,
                    'image-rotation-max': 8,
                    'enable-image-rotation-min': true,
                    'enable-image-rotation-max': true,
                    'default-sepia': 0.4,
                    'enable-default-sepia': true,
                    'default-saturate': 0.8,
                    'enable-default-saturate': true,
                    'default-contrast': 1.1,
                    'enable-default-contrast': true,
                    'default-border-width': 4,
                    'enable-default-border-width': true,
                    'default-border-color': '#d4c4a8',
                    'enable-default-border-color': true,
                    'default-shadow': 'md',
                    'enable-default-shadow': true
                }
            },
            'neon-glow': {
                name: 'Neon Glow',
                description: 'Cyberpunk aesthetic with glowing borders',
                config: {
                    'layout-algorithm': 'radial',
                    'image-rotation-mode': 'random',
                    'enable-image-rotation-mode': true,
                    'image-rotation-min': -5,
                    'image-rotation-max': 5,
                    'enable-image-rotation-min': true,
                    'enable-image-rotation-max': true,
                    'default-border-width': 2,
                    'enable-default-border-width': true,
                    'default-border-color': '#00ffff',
                    'enable-default-border-color': true,
                    'default-shadow': 'glow',
                    'enable-default-shadow': true,
                    'default-saturate': 1.3,
                    'enable-default-saturate': true,
                    'default-contrast': 1.2,
                    'enable-default-contrast': true,
                    'hover-shadow': 'glow',
                    'enable-hover-shadow': true,
                    'focused-shadow': 'glow',
                    'enable-focused-shadow': true
                }
            },
            'minimal': {
                name: 'Minimal',
                description: 'Clean look without shadows or rotation',
                config: {
                    'layout-algorithm': 'grid',
                    'enable-algorithm': true,
                    'image-rotation-mode': 'none',
                    'enable-image-rotation-mode': true,
                    'default-shadow': 'none',
                    'enable-default-shadow': true,
                    'default-border-radius': 0,
                    'enable-default-border-radius': true,
                    'hover-shadow': 'sm',
                    'enable-hover-shadow': true,
                    'focused-shadow': 'md',
                    'enable-focused-shadow': true
                }
            },
            'dramatic': {
                name: 'Dramatic',
                description: 'High contrast with strong shadows',
                config: {
                    'layout-algorithm': 'radial',
                    'image-rotation-mode': 'random',
                    'enable-image-rotation-mode': true,
                    'image-rotation-min': -20,
                    'image-rotation-max': 20,
                    'enable-image-rotation-min': true,
                    'enable-image-rotation-max': true,
                    'default-contrast': 1.3,
                    'enable-default-contrast': true,
                    'default-brightness': 0.95,
                    'enable-default-brightness': true,
                    'default-shadow': 'lg',
                    'enable-default-shadow': true,
                    'hover-shadow': 'lg',
                    'enable-hover-shadow': true,
                    'hover-brightness': 1.1,
                    'enable-hover-brightness': true
                }
            }
        };

        // Toggle accordion
        window.toggleAccordion = function(accordion) {
            const wasOpen = accordion.classList.contains('open');
            // Close all accordions
            document.querySelectorAll('.accordion').forEach(a => a.classList.remove('open'));
            // Open clicked one if it was closed
            if (!wasOpen) {
                accordion.classList.add('open');
            }
        };

        // Toggle mobile sidebar
        window.toggleSidebar = function() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        };

        // Toggle JSON paths display
        window.togglePaths = function() {
            showingPaths = !showingPaths;
            const toggle = document.querySelector('.path-toggle');
            toggle.classList.toggle('active', showingPaths);
            document.querySelectorAll('[data-label][data-path]').forEach(el => {
                if (showingPaths) {
                    el.textContent = el.dataset.path;
                    el.classList.add('show-path');
                } else {
                    el.textContent = el.dataset.label;
                    el.classList.remove('show-path');
                }
            });

            // Toggle styling path prefix visibility
            const stylingPrefix = document.getElementById('styling-path-prefix');
            if (stylingPrefix) {
                stylingPrefix.classList.toggle('show-path', showingPaths);
            }

            // Toggle custom shadow format hint visibility
            const shadowFormatHint = document.getElementById('custom-shadow-format-hint');
            if (shadowFormatHint) {
                shadowFormatHint.classList.toggle('show-path', showingPaths);
            }
        };

        // Toggle subsection enabled/disabled
        window.toggleSubsection = function(contentId, enabled) {
            const content = document.getElementById(contentId);
            if (content) {
                content.style.display = enabled ? 'block' : 'none';
                content.classList.toggle('disabled', !enabled);
            }
        };

        // Toggle rotation range controls based on mode
        window.toggleRotationRange = function() {
            const mode = document.getElementById('image-rotation-mode').value;
            const rangeControls = document.getElementById('rotation-range-controls');
            if (rangeControls) {
                rangeControls.style.display = mode === 'random' ? 'block' : 'none';
            }
            scheduleAutoApply();
        };

        // Toggle sizing mode controls (fixed vs adaptive vs responsive)
        window.toggleSizingMode = function() {
            const mode = document.getElementById('image-sizing-mode').value;
            const fixedControls = document.getElementById('fixed-sizing-controls');
            const adaptiveControls = document.getElementById('adaptive-sizing-controls');
            const responsiveControls = document.getElementById('responsive-sizing-controls');
            if (fixedControls) {
                fixedControls.style.display = mode === 'fixed' ? 'block' : 'none';
            }
            if (adaptiveControls) {
                adaptiveControls.style.display = mode === 'adaptive' ? 'block' : 'none';
            }
            if (responsiveControls) {
                responsiveControls.style.display = mode === 'responsive' ? 'block' : 'none';
            }
            scheduleAutoApply();
        };

        // Update range display value
        window.updateRangeDisplay = function(input) {
            const display = input.parentElement.querySelector('.value-display');
            if (display) {
                let value = input.value;
                if (input.id === 'default-hueRotate' || input.id === 'spiral-startAngle') {
                    value += '¬∞';
                }
                display.textContent = value;
            }
            scheduleAutoApply();
        };

        // Show algorithm-specific controls
        window.onAlgorithmChange = function() {
            const algorithm = document.getElementById('layout-algorithm').value;
            document.querySelectorAll('.algorithm-specific').forEach(el => {
                // Support both data-algorithm (single) and data-algorithms (comma-separated)
                const singleAlgo = el.dataset.algorithm;
                const multiAlgos = el.dataset.algorithms;

                let shouldShow = false;
                if (singleAlgo) {
                    shouldShow = singleAlgo === algorithm;
                } else if (multiAlgos) {
                    shouldShow = multiAlgos.split(',').includes(algorithm);
                }

                const wasVisible = el.classList.contains('visible');
                el.classList.toggle('visible', shouldShow);

                // Reset values to defaults when hiding
                if (wasVisible && !shouldShow) {
                    // Reset scaleDecay
                    const scaleDecayInput = el.querySelector('#layout-scaleDecay');
                    const scaleDecayCheckbox = el.querySelector('#enable-layout-scaleDecay');
                    if (scaleDecayInput) {
                        scaleDecayInput.value = '0';
                        updateRangeDisplay(scaleDecayInput);
                    }
                    if (scaleDecayCheckbox) {
                        scaleDecayCheckbox.checked = false;
                    }
                }
            });
            scheduleAutoApply();
        };

        // Update path preset options based on selected path type
        window.updatePathPresets = function() {
            const pathType = document.getElementById('entry-path-type').value;
            const presetRow = document.getElementById('path-preset-row');
            const presetSelect = document.getElementById('entry-path-preset');

            // Show/hide preset row based on path type
            if (pathType === 'linear') {
                presetRow.style.display = 'none';
            } else {
                presetRow.style.display = 'flex';

                // Populate preset options based on path type
                let presets = [];
                if (pathType === 'bounce') {
                    presets = [
                        { value: 'playful', label: 'Playful (default)' },
                        { value: 'energetic', label: 'Energetic' },
                        { value: 'subtle', label: 'Subtle' }
                    ];
                } else if (pathType === 'elastic') {
                    presets = [
                        { value: 'gentle', label: 'Gentle (default)' },
                        { value: 'bouncy', label: 'Bouncy' },
                        { value: 'wobbly', label: 'Wobbly' },
                        { value: 'snappy', label: 'Snappy' }
                    ];
                } else if (pathType === 'wave') {
                    presets = [
                        { value: 'gentle', label: 'Gentle (default)' },
                        { value: 'playful', label: 'Playful' },
                        { value: 'serpentine', label: 'Serpentine' },
                        { value: 'flutter', label: 'Flutter' }
                    ];
                }

                presetSelect.innerHTML = presets.map(p =>
                    `<option value="${p.value}">${p.label}</option>`
                ).join('');
            }
            scheduleAutoApply();
        };

        // Update rotation options visibility based on selected rotation mode
        window.updateRotationOptions = function() {
            const rotationMode = document.getElementById('entry-rotation-mode').value;

            // Hide all rotation-specific rows first
            document.getElementById('spin-count-row').style.display = 'none';
            document.getElementById('spin-direction-row').style.display = 'none';
            document.getElementById('settle-min-row').style.display = 'none';
            document.getElementById('wobble-amplitude-row').style.display = 'none';
            document.getElementById('wobble-frequency-row').style.display = 'none';

            // Show relevant rows based on mode
            if (rotationMode === 'spin') {
                document.getElementById('spin-count-row').style.display = 'flex';
                document.getElementById('spin-direction-row').style.display = 'flex';
            } else if (rotationMode === 'settle') {
                document.getElementById('settle-min-row').style.display = 'flex';
            } else if (rotationMode === 'wobble') {
                document.getElementById('wobble-amplitude-row').style.display = 'flex';
                document.getElementById('wobble-frequency-row').style.display = 'flex';
            }

            scheduleAutoApply();
        };

        // Update scale options visibility based on selected scale mode
        window.updateScaleOptions = function() {
            const scaleMode = document.getElementById('entry-scale-mode').value;

            // Hide all scale-specific rows first
            document.getElementById('scale-start-row').style.display = 'none';
            document.getElementById('scale-pop-overshoot-row').style.display = 'none';
            document.getElementById('scale-pop-bounces-row').style.display = 'none';
            document.getElementById('scale-random-min-row').style.display = 'none';

            // Show relevant rows based on mode
            if (scaleMode === 'grow') {
                document.getElementById('scale-start-row').style.display = 'flex';
                // Set default for grow mode
                document.getElementById('entry-scale-start').value = '0.3';
                updateRangeDisplay(document.getElementById('entry-scale-start'));
            } else if (scaleMode === 'shrink') {
                document.getElementById('scale-start-row').style.display = 'flex';
                // Set default for shrink mode
                document.getElementById('entry-scale-start').value = '1.5';
                updateRangeDisplay(document.getElementById('entry-scale-start'));
            } else if (scaleMode === 'pop') {
                document.getElementById('scale-pop-overshoot-row').style.display = 'flex';
                document.getElementById('scale-pop-bounces-row').style.display = 'flex';
            } else if (scaleMode === 'random') {
                document.getElementById('scale-random-min-row').style.display = 'flex';
            }

            scheduleAutoApply();
        };

        // Schedule auto-apply with debouncing
        function scheduleAutoApply() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                applyChanges();
            }, 300);
        }

        // Setup change listeners for auto-apply
        function setupAutoApply() {
            document.querySelectorAll('input, select').forEach(input => {
                if (input.type === 'range') {
                    // Range inputs already call updateRangeDisplay which schedules auto-apply
                    return;
                }
                input.addEventListener('change', scheduleAutoApply);
                if (input.type === 'number' || input.type === 'text') {
                    input.addEventListener('input', scheduleAutoApply);
                }
            });
        }

        // Update control row disabled state based on checkbox
        function setupCheckboxListeners() {
            document.querySelectorAll('.control-checkbox').forEach(checkbox => {
                const row = checkbox.closest('.control-row');
                if (row) {
                    checkbox.addEventListener('change', () => {
                        row.classList.toggle('disabled', !checkbox.checked);
                        scheduleAutoApply();
                    });
                    // Initialize state
                    row.classList.toggle('disabled', !checkbox.checked);
                }
            });
        }

        // Get value from control if its checkbox is enabled
        function getEnabledValue(checkboxId, controlId, parser = v => v) {
            const checkbox = document.getElementById(checkboxId);
            const control = document.getElementById(controlId);
            if (checkbox && checkbox.checked && control) {
                return parser(control.value);
            }
            return undefined;
        }

        // Build config from enabled controls
        function buildConfig() {
            const config = {
                container: 'imageCloud',
                images: getSelectedImages()
            };

            // Layout
            const layout = {};
            const algorithm = document.getElementById('layout-algorithm').value;
            if (document.getElementById('enable-algorithm')?.checked) {
                layout.algorithm = algorithm;
            }

            // Shared loader config (only include non-default values)
            const loaderConfig = {};
            if (document.getElementById('enable-validate-urls')?.checked) {
                loaderConfig.validateUrls = document.getElementById('config-validate-urls').value === 'true';
            }
            if (document.getElementById('enable-validation-method')?.checked) {
                loaderConfig.validationMethod = document.getElementById('config-validation-method').value;
            }
            if (document.getElementById('enable-validation-timeout')?.checked) {
                loaderConfig.validationTimeout = parseInt(document.getElementById('config-validation-timeout').value);
            }
            if (document.getElementById('enable-allowed-extensions')?.checked) {
                const extStr = document.getElementById('config-allowed-extensions').value.trim();
                if (extStr) loaderConfig.allowedExtensions = extStr.split(',').map(e => e.trim()).filter(Boolean);
            }

            // Debug config (only include when enabled, since defaults are off)
            const debugConfig = {};
            if (document.getElementById('debug-enabled')?.checked) debugConfig.enabled = true;
            if (document.getElementById('debug-centers')?.checked) debugConfig.centers = true;
            if (document.getElementById('debug-loaders')?.checked) debugConfig.loaders = true;

            // Image Config (new structure)
            const image = {};

            // Image Sizing
            const imageSizing = {};

            // Sizing mode
            const sizingMode = document.getElementById('image-sizing-mode')?.value;
            if (document.getElementById('enable-image-sizing-mode')?.checked && sizingMode) {
                imageSizing.mode = sizingMode;

                if (sizingMode === 'fixed') {
                    // Fixed mode: use single height value
                    const height = getEnabledValue('enable-image-height', 'image-height', parseInt);
                    if (height !== undefined) imageSizing.height = height;
                } else if (sizingMode === 'responsive') {
                    // Responsive mode: use breakpoint-specific heights
                    const heightObj = {};
                    const mobile = getEnabledValue('enable-height-mobile', 'height-mobile', parseInt);
                    const tablet = getEnabledValue('enable-height-tablet', 'height-tablet', parseInt);
                    const screen = getEnabledValue('enable-height-screen', 'height-screen', parseInt);

                    if (mobile !== undefined) heightObj.mobile = mobile;
                    if (tablet !== undefined) heightObj.tablet = tablet;
                    if (screen !== undefined) heightObj.screen = screen;

                    if (Object.keys(heightObj).length > 0) {
                        imageSizing.height = heightObj;
                    }
                } else {
                    // Adaptive mode: use minSize/maxSize
                    const minSize = getEnabledValue('enable-image-minSize', 'image-minSize', parseInt);
                    const maxSize = getEnabledValue('enable-image-maxSize', 'image-maxSize', parseInt);
                    if (minSize !== undefined) imageSizing.minSize = minSize;
                    if (maxSize !== undefined) imageSizing.maxSize = maxSize;
                }
            }

            const variance = {};
            const vMin = getEnabledValue('enable-image-variance-min', 'image-variance-min', parseFloat);
            const vMax = getEnabledValue('enable-image-variance-max', 'image-variance-max', parseFloat);
            if (vMin !== undefined) variance.min = vMin;
            if (vMax !== undefined) variance.max = vMax;
            if (Object.keys(variance).length > 0) imageSizing.variance = variance;

            if (Object.keys(imageSizing).length > 0) image.sizing = imageSizing;

            // Image Rotation
            const imageRotation = {};
            const rotationMode = document.getElementById('image-rotation-mode')?.value;
            if (document.getElementById('enable-image-rotation-mode')?.checked && rotationMode) {
                imageRotation.mode = rotationMode;

                // Range only applies to 'random' mode
                if (rotationMode === 'random') {
                    const range = {};
                    const rMin = getEnabledValue('enable-image-rotation-min', 'image-rotation-min', parseInt);
                    const rMax = getEnabledValue('enable-image-rotation-max', 'image-rotation-max', parseInt);
                    if (rMin !== undefined) range.min = rMin;
                    if (rMax !== undefined) range.max = rMax;
                    if (Object.keys(range).length > 0) imageRotation.range = range;
                }
            }
            if (Object.keys(imageRotation).length > 0) image.rotation = imageRotation;

            if (Object.keys(image).length > 0) config.image = image;

            // Layout-level settings
            const coverage = getEnabledValue('enable-layout-coverage', 'layout-coverage', parseFloat);
            const density = getEnabledValue('enable-layout-density', 'layout-density', parseFloat);
            const scaleDecay = getEnabledValue('enable-layout-scaleDecay', 'layout-scaleDecay', parseFloat);
            if (coverage !== undefined) layout.targetCoverage = coverage;
            if (density !== undefined) layout.densityFactor = density;
            if (scaleDecay !== undefined) layout.scaleDecay = scaleDecay;

            // Spacing
            const spacing = {};
            const padding = getEnabledValue('enable-spacing-padding', 'spacing-padding', parseInt);
            const minGap = getEnabledValue('enable-spacing-minGap', 'spacing-minGap', parseInt);
            if (padding !== undefined) spacing.padding = padding;
            if (minGap !== undefined) spacing.minGap = minGap;
            if (Object.keys(spacing).length > 0) layout.spacing = spacing;

            // Algorithm-specific
            if (algorithm === 'grid') {
                const grid = {};
                const columns = getEnabledValue('enable-grid-columns', 'grid-columns', parseInt);
                const rows = getEnabledValue('enable-grid-rows', 'grid-rows', parseInt);
                const gap = getEnabledValue('enable-grid-gap', 'grid-gap', parseInt);
                const stagger = getEnabledValue('enable-grid-stagger', 'grid-stagger');
                const jitter = getEnabledValue('enable-grid-jitter', 'grid-jitter', parseInt);
                const overlap = getEnabledValue('enable-grid-overlap', 'grid-overlap', parseFloat);
                const fillDirection = getEnabledValue('enable-grid-fillDirection', 'grid-fillDirection');
                const alignment = getEnabledValue('enable-grid-alignment', 'grid-alignment');
                const overflowOffset = getEnabledValue('enable-grid-overflowOffset', 'grid-overflowOffset', parseFloat);
                if (columns !== undefined) grid.columns = columns;
                if (rows !== undefined) grid.rows = rows;
                if (gap !== undefined) grid.gap = gap;
                if (stagger !== undefined) grid.stagger = stagger;
                if (jitter !== undefined) grid.jitter = jitter;
                if (overlap !== undefined) grid.overlap = overlap;
                if (fillDirection !== undefined) grid.fillDirection = fillDirection;
                if (alignment !== undefined) grid.alignment = alignment;
                if (overflowOffset !== undefined) grid.overflowOffset = overflowOffset;
                if (Object.keys(grid).length > 0) layout.grid = grid;
            } else if (algorithm === 'spiral') {
                const spiral = {};
                const spiralType = getEnabledValue('enable-spiral-type', 'spiral-type');
                const direction = getEnabledValue('enable-spiral-direction', 'spiral-direction');
                const tightness = getEnabledValue('enable-spiral-tightness', 'spiral-tightness', parseFloat);
                const startAngle = getEnabledValue('enable-spiral-startAngle', 'spiral-startAngle', parseInt);
                if (spiralType !== undefined) spiral.spiralType = spiralType;
                if (direction !== undefined) spiral.direction = direction;
                if (tightness !== undefined) spiral.tightness = tightness;
                if (startAngle !== undefined) spiral.startAngle = startAngle;
                if (Object.keys(spiral).length > 0) layout.spiral = spiral;
            } else if (algorithm === 'cluster') {
                const cluster = {};
                const count = getEnabledValue('enable-cluster-count', 'cluster-count', parseInt);
                const spread = getEnabledValue('enable-cluster-spread', 'cluster-spread', parseInt);
                const spacing = getEnabledValue('enable-cluster-spacing', 'cluster-spacing', parseInt);
                const overlap = getEnabledValue('enable-cluster-overlap', 'cluster-overlap', parseFloat);
                const density = getEnabledValue('enable-cluster-density', 'cluster-density');
                const distribution = getEnabledValue('enable-cluster-distribution', 'cluster-distribution');
                if (count !== undefined) cluster.clusterCount = count;
                if (spread !== undefined) cluster.clusterSpread = spread;
                if (spacing !== undefined) cluster.clusterSpacing = spacing;
                if (overlap !== undefined) cluster.overlap = overlap;
                if (density !== undefined) cluster.density = density;
                if (distribution !== undefined) cluster.distribution = distribution;
                if (Object.keys(cluster).length > 0) layout.cluster = cluster;
            } else if (algorithm === 'wave') {
                const wave = {};
                const rows = getEnabledValue('enable-wave-rows', 'wave-rows', parseInt);
                const amplitude = getEnabledValue('enable-wave-amplitude', 'wave-amplitude', parseInt);
                const frequency = getEnabledValue('enable-wave-frequency', 'wave-frequency', parseFloat);
                const phaseShift = getEnabledValue('enable-wave-phaseShift', 'wave-phaseShift', parseFloat);
                const synchronization = getEnabledValue('enable-wave-synchronization', 'wave-synchronization');
                // Note: orientation removed - use image.rotation.mode = 'tangent' instead
                if (rows !== undefined) wave.rows = rows;
                if (amplitude !== undefined) wave.amplitude = amplitude;
                if (frequency !== undefined) wave.frequency = frequency;
                if (phaseShift !== undefined) wave.phaseShift = phaseShift;
                if (synchronization !== undefined) wave.synchronization = synchronization;
                if (Object.keys(wave).length > 0) layout.wave = wave;
            }

            if (Object.keys(layout).length > 0) config.layout = layout;

            // Animation
            const animation = {};
            const duration = getEnabledValue('enable-animation-duration', 'animation-duration', parseInt);
            if (duration !== undefined) animation.duration = duration;

            // Queue (enabled defaults to true, so only include when false)
            const queueEnabled = document.getElementById('enable-queue')?.checked;
            if (queueEnabled !== undefined) {
                const queue = {};
                if (!queueEnabled) {
                    queue.enabled = false;
                } else {
                    const interval = getEnabledValue('enable-queue-interval', 'queue-interval', parseInt);
                    if (interval !== undefined) queue.interval = interval;
                }
                if (Object.keys(queue).length > 0) animation.queue = queue;
            }

            // Entry
            const entry = {};
            const entryStart = {};
            const position = getEnabledValue('enable-entry-position', 'entry-position');
            const offset = getEnabledValue('enable-entry-offset', 'entry-offset', parseInt);
            if (position !== undefined) entryStart.position = position;
            if (offset !== undefined) entryStart.offset = offset;
            if (Object.keys(entryStart).length > 0) entry.start = entryStart;

            const entryTiming = {};
            const entryDuration = getEnabledValue('enable-entry-duration', 'entry-duration', parseInt);
            if (entryDuration !== undefined) entryTiming.duration = entryDuration;
            if (Object.keys(entryTiming).length > 0) entry.timing = entryTiming;

            // Path configuration
            const pathEnabled = document.getElementById('enable-entry-path').checked;
            if (pathEnabled) {
                const pathType = document.getElementById('entry-path-type').value;
                if (pathType !== 'linear') {
                    const path = { type: pathType };
                    const presetEnabled = document.getElementById('enable-entry-path-preset').checked;
                    if (presetEnabled) {
                        const preset = document.getElementById('entry-path-preset').value;
                        if (pathType === 'bounce') path.bouncePreset = preset;
                        else if (pathType === 'elastic') path.elasticPreset = preset;
                        else if (pathType === 'wave') path.wavePreset = preset;
                    }
                    entry.path = path;
                }
            }

            // Rotation configuration
            const rotationEnabled = document.getElementById('enable-entry-rotation').checked;
            if (rotationEnabled) {
                const rotationMode = document.getElementById('entry-rotation-mode').value;
                if (rotationMode !== 'none') {
                    const rotation = { mode: rotationMode };

                    if (rotationMode === 'spin') {
                        const spinCountEnabled = document.getElementById('enable-spin-count').checked;
                        if (spinCountEnabled) {
                            rotation.spinCount = parseInt(document.getElementById('entry-spin-count').value);
                        }
                        const spinDirectionEnabled = document.getElementById('enable-spin-direction').checked;
                        if (spinDirectionEnabled) {
                            rotation.direction = document.getElementById('entry-spin-direction').value;
                        }
                    } else if (rotationMode === 'settle') {
                        const settleRangeEnabled = document.getElementById('enable-settle-range').checked;
                        if (settleRangeEnabled) {
                            rotation.startRotation = {
                                min: parseInt(document.getElementById('entry-settle-min').value),
                                max: parseInt(document.getElementById('entry-settle-max').value)
                            };
                        }
                    } else if (rotationMode === 'wobble') {
                        const wobble = {};
                        const wobbleConfigEnabled = document.getElementById('enable-wobble-config').checked;
                        if (wobbleConfigEnabled) {
                            wobble.amplitude = parseInt(document.getElementById('entry-wobble-amplitude').value);
                        }
                        const wobbleFreqEnabled = document.getElementById('enable-wobble-frequency').checked;
                        if (wobbleFreqEnabled) {
                            wobble.frequency = parseInt(document.getElementById('entry-wobble-frequency').value);
                        }
                        if (Object.keys(wobble).length > 0) {
                            wobble.decay = true; // Always include decay
                            rotation.wobble = wobble;
                        }
                    }

                    entry.rotation = rotation;
                }
            }

            // Scale configuration
            const scaleEnabled = document.getElementById('enable-entry-scale').checked;
            if (scaleEnabled) {
                const scaleMode = document.getElementById('entry-scale-mode').value;
                if (scaleMode !== 'none') {
                    const scale = { mode: scaleMode };

                    if (scaleMode === 'grow' || scaleMode === 'shrink') {
                        const startScaleEnabled = document.getElementById('enable-scale-start').checked;
                        if (startScaleEnabled) {
                            scale.startScale = parseFloat(document.getElementById('entry-scale-start').value);
                        }
                    } else if (scaleMode === 'pop') {
                        const pop = {};
                        const overshootEnabled = document.getElementById('enable-pop-overshoot').checked;
                        if (overshootEnabled) {
                            pop.overshoot = parseFloat(document.getElementById('entry-pop-overshoot').value);
                        }
                        const bouncesEnabled = document.getElementById('enable-pop-bounces').checked;
                        if (bouncesEnabled) {
                            pop.bounces = parseInt(document.getElementById('entry-pop-bounces').value);
                        }
                        if (Object.keys(pop).length > 0) {
                            scale.pop = pop;
                        }
                    } else if (scaleMode === 'random') {
                        const rangeEnabled = document.getElementById('enable-scale-range').checked;
                        if (rangeEnabled) {
                            scale.range = {
                                min: parseFloat(document.getElementById('entry-scale-random-min').value),
                                max: parseFloat(document.getElementById('entry-scale-random-max').value)
                            };
                        }
                    }

                    entry.scale = scale;
                }
            }

            if (Object.keys(entry).length > 0) animation.entry = entry;
            if (Object.keys(animation).length > 0) config.animation = animation;

            // Interaction
            const interaction = {};
            const focus = {};
            const scalePercent = getEnabledValue('enable-focus-scalePercent', 'focus-scalePercent', parseFloat);
            const zIndex = getEnabledValue('enable-focus-zIndex', 'focus-zIndex', parseInt);
            if (scalePercent !== undefined) focus.scalePercent = scalePercent;
            if (zIndex !== undefined) focus.zIndex = zIndex;
            if (Object.keys(focus).length > 0) interaction.focus = focus;
            if (Object.keys(interaction).length > 0) config.interaction = interaction;

            // Styling - build from stylingState
            const styling = {};

            // Helper to build state config from stylingState
            function buildStateConfig(stateName) {
                const stateConfig = {};
                const border = {};
                const borderTop = {};
                const borderRight = {};
                const borderBottom = {};
                const borderLeft = {};
                const outline = {};
                const filter = {};

                for (const [prop, data] of Object.entries(stylingState[stateName])) {
                    if (!data.enabled) continue;

                    if (prop.startsWith('borderTop.')) {
                        const borderProp = prop.replace('borderTop.', '');
                        borderTop[borderProp] = data.value;
                    } else if (prop.startsWith('borderRight.')) {
                        const borderProp = prop.replace('borderRight.', '');
                        borderRight[borderProp] = data.value;
                    } else if (prop.startsWith('borderBottom.')) {
                        const borderProp = prop.replace('borderBottom.', '');
                        borderBottom[borderProp] = data.value;
                    } else if (prop.startsWith('borderLeft.')) {
                        const borderProp = prop.replace('borderLeft.', '');
                        borderLeft[borderProp] = data.value;
                    } else if (prop.startsWith('border.')) {
                        const borderProp = prop.replace('border.', '');
                        border[borderProp] = data.value;
                    } else if (prop === 'borderRadiusTopLeft') {
                        stateConfig.borderRadiusTopLeft = data.value;
                    } else if (prop === 'borderRadiusTopRight') {
                        stateConfig.borderRadiusTopRight = data.value;
                    } else if (prop === 'borderRadiusBottomRight') {
                        stateConfig.borderRadiusBottomRight = data.value;
                    } else if (prop === 'borderRadiusBottomLeft') {
                        stateConfig.borderRadiusBottomLeft = data.value;
                    } else if (prop.startsWith('outline.')) {
                        const outlineProp = prop.replace('outline.', '');
                        outline[outlineProp] = data.value;
                    } else if (prop.startsWith('filter.')) {
                        const filterProp = prop.replace('filter.', '');
                        filter[filterProp] = data.value;
                    } else if (prop === 'shadow') {
                        // If custom shadow, build CSS string from custom state
                        if (data.value === 'custom') {
                            stateConfig.shadow = buildCustomShadow(customShadowState[stateName]);
                        } else {
                            stateConfig.shadow = data.value;
                        }
                    } else if (prop === 'clipPath') {
                        // Include clipPath value (predefined shape, 'none' to clear, custom string, or config object with mode)
                        if (data.value || data.shape) {
                            // If data has mode, use the full object with shape and mode; otherwise use just the value
                            if (data.mode) {
                                stateConfig.clipPath = { shape: data.value, mode: data.mode };
                            } else {
                                stateConfig.clipPath = data.value;
                            }
                        }
                    } else if (prop === 'opacity') {
                        stateConfig.opacity = data.value;
                    } else if (prop === 'cursor') {
                        stateConfig.cursor = data.value;
                    }
                }

                if (Object.keys(border).length > 0) stateConfig.border = border;
                if (Object.keys(borderTop).length > 0) stateConfig.borderTop = borderTop;
                if (Object.keys(borderRight).length > 0) stateConfig.borderRight = borderRight;
                if (Object.keys(borderBottom).length > 0) stateConfig.borderBottom = borderBottom;
                if (Object.keys(borderLeft).length > 0) stateConfig.borderLeft = borderLeft;
                if (Object.keys(outline).length > 0) stateConfig.outline = outline;
                if (Object.keys(filter).length > 0) stateConfig.filter = filter;

                return stateConfig;
            }

            const defaultState = buildStateConfig('default');
            const hoverState = buildStateConfig('hover');
            const focusedState = buildStateConfig('focused');

            if (Object.keys(defaultState).length > 0) styling.default = defaultState;
            if (Object.keys(hoverState).length > 0) styling.hover = hoverState;
            if (Object.keys(focusedState).length > 0) styling.focused = focusedState;

            if (Object.keys(styling).length > 0) config.styling = styling;

            // Config section (loaders + debug)
            if (Object.keys(loaderConfig).length > 0 || Object.keys(debugConfig).length > 0) {
                if (!config.config) config.config = {};
                if (Object.keys(loaderConfig).length > 0) config.config.loaders = loaderConfig;
                if (Object.keys(debugConfig).length > 0) config.config.debug = debugConfig;
            }

            return config;
        }

        // Apply preset
        window.applyPreset = function(presetKey) {
            const preset = presets[presetKey];
            if (!preset) return;

            // Reset all checkboxes (except styling ones which we handle separately)
            document.querySelectorAll('.control-checkbox:not(.styling-checkbox)').forEach(cb => {
                cb.checked = false;
                const row = cb.closest('.control-row');
                if (row) row.classList.add('disabled');
            });

            // Reset styling state
            initStylingState();

            // Reset subsection toggles
            document.getElementById('enable-queue').checked = true;
            toggleSubsection('queue-content', true);

            // Reset image sizing to adaptive mode
            document.getElementById('image-sizing-mode').value = 'adaptive';
            document.getElementById('enable-image-sizing-mode').checked = true;
            toggleSizingMode();

            // Reset image rotation to default
            document.getElementById('image-rotation-mode').value = 'none';
            document.getElementById('enable-image-rotation-mode').checked = false;
            toggleRotationRange();

            // Reset algorithm
            document.getElementById('layout-algorithm').value = 'radial';
            document.getElementById('enable-algorithm').checked = true;
            onAlgorithmChange();

            // Map old preset keys to new styling state
            const stylingKeyMap = {
                'default-border-width': { state: 'default', prop: 'border.width' },
                'default-border-color': { state: 'default', prop: 'border.color' },
                'default-border-style': { state: 'default', prop: 'border.style' },
                'default-border-radius': { state: 'default', prop: 'border.radius' },
                'default-outline-width': { state: 'default', prop: 'outline.width' },
                'default-outline-color': { state: 'default', prop: 'outline.color' },
                'default-outline-style': { state: 'default', prop: 'outline.style' },
                'default-outline-offset': { state: 'default', prop: 'outline.offset' },
                'default-shadow': { state: 'default', prop: 'shadow' },
                'default-opacity': { state: 'default', prop: 'opacity' },
                'default-cursor': { state: 'default', prop: 'cursor' },
                'default-grayscale': { state: 'default', prop: 'filter.grayscale' },
                'default-blur': { state: 'default', prop: 'filter.blur' },
                'default-brightness': { state: 'default', prop: 'filter.brightness' },
                'default-contrast': { state: 'default', prop: 'filter.contrast' },
                'default-saturate': { state: 'default', prop: 'filter.saturate' },
                'default-sepia': { state: 'default', prop: 'filter.sepia' },
                'default-hueRotate': { state: 'default', prop: 'filter.hueRotate' },
                'default-invert': { state: 'default', prop: 'filter.invert' },
                'hover-border-width': { state: 'hover', prop: 'border.width' },
                'hover-border-color': { state: 'hover', prop: 'border.color' },
                'hover-border-style': { state: 'hover', prop: 'border.style' },
                'hover-border-radius': { state: 'hover', prop: 'border.radius' },
                'hover-outline-width': { state: 'hover', prop: 'outline.width' },
                'hover-outline-color': { state: 'hover', prop: 'outline.color' },
                'hover-outline-style': { state: 'hover', prop: 'outline.style' },
                'hover-outline-offset': { state: 'hover', prop: 'outline.offset' },
                'hover-shadow': { state: 'hover', prop: 'shadow' },
                'hover-opacity': { state: 'hover', prop: 'opacity' },
                'hover-cursor': { state: 'hover', prop: 'cursor' },
                'hover-grayscale': { state: 'hover', prop: 'filter.grayscale' },
                'hover-blur': { state: 'hover', prop: 'filter.blur' },
                'hover-brightness': { state: 'hover', prop: 'filter.brightness' },
                'hover-contrast': { state: 'hover', prop: 'filter.contrast' },
                'hover-saturate': { state: 'hover', prop: 'filter.saturate' },
                'hover-sepia': { state: 'hover', prop: 'filter.sepia' },
                'hover-hueRotate': { state: 'hover', prop: 'filter.hueRotate' },
                'hover-invert': { state: 'hover', prop: 'filter.invert' },
                'focused-border-width': { state: 'focused', prop: 'border.width' },
                'focused-border-color': { state: 'focused', prop: 'border.color' },
                'focused-border-style': { state: 'focused', prop: 'border.style' },
                'focused-border-radius': { state: 'focused', prop: 'border.radius' },
                'focused-outline-width': { state: 'focused', prop: 'outline.width' },
                'focused-outline-color': { state: 'focused', prop: 'outline.color' },
                'focused-outline-style': { state: 'focused', prop: 'outline.style' },
                'focused-outline-offset': { state: 'focused', prop: 'outline.offset' },
                'focused-shadow': { state: 'focused', prop: 'shadow' },
                'focused-opacity': { state: 'focused', prop: 'opacity' },
                'focused-cursor': { state: 'focused', prop: 'cursor' },
                'focused-grayscale': { state: 'focused', prop: 'filter.grayscale' },
                'focused-blur': { state: 'focused', prop: 'filter.blur' },
                'focused-brightness': { state: 'focused', prop: 'filter.brightness' },
                'focused-contrast': { state: 'focused', prop: 'filter.contrast' },
                'focused-saturate': { state: 'focused', prop: 'filter.saturate' },
                'focused-sepia': { state: 'focused', prop: 'filter.sepia' },
                'focused-hueRotate': { state: 'focused', prop: 'filter.hueRotate' },
                'focused-invert': { state: 'focused', prop: 'filter.invert' }
            };

            // Apply preset config
            const cfg = preset.config;
            for (const [key, value] of Object.entries(cfg)) {
                // Handle styling keys
                if (stylingKeyMap[key]) {
                    const { state, prop } = stylingKeyMap[key];
                    stylingState[state][prop] = { enabled: false, value: value };
                    continue;
                }

                // Handle enable-* styling keys
                if (key.startsWith('enable-')) {
                    const valueKey = key.replace('enable-', '');
                    if (stylingKeyMap[valueKey]) {
                        const { state, prop } = stylingKeyMap[valueKey];
                        stylingState[state][prop].enabled = value;
                        continue;
                    }
                }

                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value;
                        // Handle subsection toggles
                        if (key === 'enable-queue') {
                            toggleSubsection('queue-content', value);
                        } else {
                            // Regular control checkbox
                            const row = element.closest('.control-row');
                            if (row) row.classList.toggle('disabled', !value);
                        }
                    } else {
                        element.value = value;
                        // Update range displays
                        if (element.type === 'range') {
                            const display = element.parentElement?.querySelector('.value-display');
                            if (display) {
                                display.textContent = element.id === 'style-hueRotate' ? value + '¬∞' : value;
                            }
                        }
                        // Handle rotation mode change
                        if (key === 'image-rotation-mode') {
                            toggleRotationRange();
                        }
                        // Handle sizing mode change
                        if (key === 'image-sizing-mode') {
                            toggleSizingMode();
                        }
                    }
                }
            }

            // Handle special case for algorithm selection
            if (cfg['layout-algorithm']) {
                document.getElementById('layout-algorithm').value = cfg['layout-algorithm'];
                onAlgorithmChange();
            }

            // Reset to default state view and populate form
            selectStylingState('default');

            applyChanges();
        };

        // Apply changes to gallery
        window.applyChanges = async function() {
            const config = buildConfig();
            const configHash = JSON.stringify(config);

            // Skip refresh if config hasn't changed since last apply
            if (configHash === lastAppliedConfig) {
                return;
            }

            lastAppliedConfig = configHash;

            if (gallery) {
                gallery.destroy();
            }
            gallery = new ImageCloud(config);
            await gallery.init();
        };

        // Generate config for display (without images)
        function getDisplayConfig() {
            const config = buildConfig();
            // Remove container and images from display config
            delete config.container;
            delete config.images;
            return config;
        }

        // Get JSON string based on format toggle
        function getConfigJsonString() {
            const config = getDisplayConfig();
            const singleLine = document.getElementById('singleLineJson').checked;
            return singleLine ? JSON.stringify(config) : JSON.stringify(config, null, 2);
        }

        // Update config display when format changes
        window.updateConfigDisplay = function() {
            document.getElementById('configOutput').textContent = getConfigJsonString();
        };

        // Show config modal
        window.showConfig = function() {
            document.getElementById('singleLineJson').checked = false;
            document.getElementById('configOutput').textContent = getConfigJsonString();
            document.getElementById('configModal').classList.add('active');
        };

        // Hide config modal
        window.hideConfig = function() {
            document.getElementById('configModal').classList.remove('active');
        };

        // Copy config to clipboard
        window.copyConfig = function() {
            navigator.clipboard.writeText(getConfigJsonString()).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy to Clipboard';
                    btn.classList.remove('copied');
                }, 2000);
            });
        };

        // Show help modal
        window.showHelp = function() {
            document.getElementById('helpModal').classList.add('active');
        };

        // Hide help modal
        window.hideHelp = function() {
            document.getElementById('helpModal').classList.remove('active');
        };

        // Close modals on backdrop click
        document.getElementById('configModal').addEventListener('click', function(e) {
            if (e.target === this) hideConfig();
        });
        document.getElementById('helpModal').addEventListener('click', function(e) {
            if (e.target === this) hideHelp();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initStylingState();
            setupCheckboxListeners();
            setupStylingListeners();
            setupAutoApply();
            onAlgorithmChange();
            populateStylingForm('default');
            applyChanges();
            loadFieldDescriptions();
        });
    </script>
</body>
</html>
